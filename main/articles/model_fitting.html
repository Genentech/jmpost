<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="jmpost">
<title>Model Fitting • jmpost</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Model Fitting">
<meta property="og:description" content="jmpost">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">jmpost</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/model_fitting.html">Model Fitting</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-reports">Reports</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-reports">
    <a class="dropdown-item" href="../coverage-report/">Coverage report</a>
    <a class="dropdown-item" href="../unit-test-report/">Unit test report</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/genentech/jmpost">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Model Fitting</h1>
            
      
      
      <div class="d-none name"><code>model_fitting.Rmd</code></div>
    </div>

    
    
<p>Here we describe the basic steps of joint model fitting with
<code>{jmpost}</code>.</p>
<div class="section level2">
<h2 id="model-specification">Model Specification<a class="anchor" aria-label="anchor" href="#model-specification"></a>
</h2>
<p>Each <code>JointModel</code> needs to be specified with three parts:
1. <code>longitudinal</code>: The model for the longitudinal outcomes.
2. <code>survival</code>: The model for the survival outcomes. 3.
<code>link</code>: The link that specifies how the
<code>longitudinal</code> model parameters enter the
<code>survival</code> model.</p>
<div class="section level3">
<h3 id="default-options">Default Options<a class="anchor" aria-label="anchor" href="#default-options"></a>
</h3>
<p>Let’s first specify a very simple joint model with: 1. A random slope
model for the longitudinal outcome. 2. A Weibull proportional hazards
model for the survival outcome. 3. The link between the two models is
that the random slope from the longitudinal model enters as a product
with a link coefficient into the linear predictor of the survival
model.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simple_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/JointModel-class.html">JointModel</a></span><span class="op">(</span></span>
<span>    longitudinal <span class="op">=</span> <span class="fu"><a href="../reference/LongitudinalRandomSlope-class.html">LongitudinalRandomSlope</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    link <span class="op">=</span> <span class="fu"><a href="../reference/LinkRandomSlope-class.html">LinkRandomSlope</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    survival <span class="op">=</span> <span class="fu"><a href="../reference/SurvivalWeibullPH-class.html">SurvivalWeibullPH</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note that here we use all the default options for the two models and
the link, in particular the prior distributions and the initial values
in the MCMC chain for the parameters are automatically chosen. Currently
we can see this only from the arguments of the constructors:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/args.html" class="external-link">args</a></span><span class="op">(</span><span class="va">LongitudinalRandomSlope</span><span class="op">)</span></span>
<span><span class="co">#&gt; function (intercept = prior_normal(30, 10, init = 30), slope_mu = prior_normal(0, </span></span>
<span><span class="co">#&gt;     15, init = 0.001), slope_sigma = prior_cauchy(0, 4, init = 0.4), </span></span>
<span><span class="co">#&gt;     sigma = prior_cauchy(0, 4, init = 0.4), random_slope = prior_none(init = 0)) </span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>So here we see that there are 4 model parameters with a proper prior
and an additional <code>random_slope</code> one where just the initial
value can be specified.</p>
</div>
<div class="section level3">
<h3 id="specifying-prior-and-initial-values">Specifying Prior and Initial Values<a class="anchor" aria-label="anchor" href="#specifying-prior-and-initial-values"></a>
</h3>
<p>We can alternatively also specify the prior distributions and the
initial values for the parameters manually. This is important in
practice to obtain a meaningful model specification and hence converging
MCMC chains that allow to estimate the posterior distributions.</p>
<p>For the random slope model for the longitudinal outcome, we can
e.g. say:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">random_slope_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/LongitudinalRandomSlope-class.html">LongitudinalRandomSlope</a></span><span class="op">(</span></span>
<span>    intercept <span class="op">=</span> <span class="fu"><a href="../reference/prior_normal.html">prior_normal</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>    slope_mu <span class="op">=</span> <span class="fu"><a href="../reference/prior_normal.html">prior_normal</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">2</span>, init <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This sets the prior for the <code>intercept</code>, without stating
an explicit initial value. In this case the <code>init</code> value is
just set to the mean of the normal distribution, so 40. This also sets
the prior and a different than the mean initial value for the
<code>slope_mu</code> parameter. The other paramaters are left with
their default priors and initial values.</p>
</div>
<div class="section level3">
<h3 id="separate-models">Separate Models<a class="anchor" aria-label="anchor" href="#separate-models"></a>
</h3>
<p>It is also possible to not link the longitudinal and the survival
models, by using the special <code>LinkNone</code> link specification.
For example,</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simple_model_no_link</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/JointModel-class.html">JointModel</a></span><span class="op">(</span></span>
<span>    longitudinal <span class="op">=</span> <span class="fu"><a href="../reference/LongitudinalRandomSlope-class.html">LongitudinalRandomSlope</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    link <span class="op">=</span> <span class="fu"><a href="../reference/LinkNone-class.html">LinkNone</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    survival <span class="op">=</span> <span class="fu"><a href="../reference/SurvivalWeibullPH-class.html">SurvivalWeibullPH</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>would allow to fit the two models separately, but in the same MCMC
chain.</p>
</div>
<div class="section level3">
<h3 id="single-models">Single Models<a class="anchor" aria-label="anchor" href="#single-models"></a>
</h3>
<p>It is also possible to specify only the longitudinal or the survival
model. Then these can be estimated on their own with separate MCMC
chains.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">single_longitudinal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/JointModel-class.html">JointModel</a></span><span class="op">(</span></span>
<span>    longitudinal <span class="op">=</span> <span class="fu"><a href="../reference/LongitudinalRandomSlope-class.html">LongitudinalRandomSlope</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">single_survival</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/JointModel-class.html">JointModel</a></span><span class="op">(</span></span>
<span>    survival <span class="op">=</span> <span class="fu"><a href="../reference/SurvivalWeibullPH-class.html">SurvivalWeibullPH</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="data-preparation">Data Preparation<a class="anchor" aria-label="anchor" href="#data-preparation"></a>
</h2>
<p>Before we can fit the models, we need to prepare the data in the
right format.</p>
<div class="section level3">
<h3 id="simulating-data">Simulating Data<a class="anchor" aria-label="anchor" href="#simulating-data"></a>
</h3>
<p>Here we start from a simulated data set.</p>
<ul>
<li>We assign 500 patients each to the two treatment arms.</li>
<li>We use a time grid from 1 to 2000, e.g. specifying the days after
randomization.</li>
<li>We use an exponentially distributed censoring time with mean of 9000
days.</li>
<li>We use a categorical covariate with three levels A, B and C in the
overall survival model, drawn uniformly from the three levels. (Note
that this is hardcoded at the moment, so the levels need to be A, B,
C.)</li>
<li>We use another continuous covariate in the overall survival model
generated from a standard normal distribution, with coefficient
0.3.</li>
<li>For the longitudinal outcome, we draw the values from a random slope
model with the given parameters.</li>
<li>For the survival outcome, we draw the true value from a Weibull
model. Note that it is fairly easy to put here another choice, you just
need to specify a function of <code>time</code> returning the log
baseline hazard under the given survival model.</li>
</ul>
<p>So let’s run the code for that:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">129</span><span class="op">)</span></span>
<span><span class="va">sim_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_joint_data.html">simulate_joint_data</a></span><span class="op">(</span></span>
<span>    n_arm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">500</span><span class="op">)</span>,</span>
<span>    times <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2000</span>,</span>
<span>    lambda_cen <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">9000</span>,</span>
<span>    beta_cat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        <span class="st">"A"</span> <span class="op">=</span> <span class="fl">0</span>,</span>
<span>        <span class="st">"B"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span>,</span>
<span>        <span class="st">"C"</span> <span class="op">=</span> <span class="fl">0.5</span></span>
<span>    <span class="op">)</span>,</span>
<span>    beta_cont <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>    lm_fun <span class="op">=</span> <span class="fu"><a href="../reference/sim_lm_random_slope.html">sim_lm_random_slope</a></span><span class="op">(</span></span>
<span>        intercept <span class="op">=</span> <span class="fl">30</span>,</span>
<span>        slope_mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>        slope_sigma <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>        sigma <span class="op">=</span> <span class="fl">3</span>,</span>
<span>        phi <span class="op">=</span> <span class="fl">0.1</span></span>
<span>    <span class="op">)</span>,</span>
<span>    os_fun <span class="op">=</span> <span class="fu"><a href="../reference/sim_os_weibull.html">sim_os_weibull</a></span><span class="op">(</span></span>
<span>        lambda <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">300</span>,</span>
<span>        gamma <span class="op">=</span> <span class="fl">0.97</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; 11 patients did not die before max(times)</span></span></code></pre></div>
<p>We get a message here that a few patients did not die before the day
2000, but this is not of concern. Basically it just gives us a feeling
of how many survival events are included in the data set.</p>
</div>
<div class="section level3">
<h3 id="formatting-data">Formatting Data<a class="anchor" aria-label="anchor" href="#formatting-data"></a>
</h3>
<p>Next we bring the data into the right format.</p>
<p>We start with extracting data into individual data sets, and then
reducing the longitudinal data to specific time points.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">os_data</span> <span class="op">&lt;-</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">os</span></span>
<span><span class="va">long_data</span> <span class="op">&lt;-</span> <span class="va">sim_data</span><span class="op">$</span><span class="va">lm</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">150</span>, <span class="fl">200</span>, <span class="fl">250</span>, <span class="fl">300</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">pt</span><span class="op">)</span></span></code></pre></div>
<p>Let’s have a quick look at the format:</p>
<p>The survival data has: - patient ID - time point - continuous
covariate value - categorical covariate level - event indicator (1 for
observed, 0 for censored) - study ID - treatment arm</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">os_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 7</span></span></span>
<span><span class="co">#&gt;   pt         time cov_cont cov_cat event study   arm    </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> pt_00001  135     -<span style="color: #BB0000;">1.12</span>  C           1 Study-1 Group-1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> pt_00002 <span style="text-decoration: underline;">1</span>385     -<span style="color: #BB0000;">0.990</span> B           1 Study-1 Group-1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> pt_00003  278     -<span style="color: #BB0000;">1.37</span>  C           1 Study-1 Group-1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> pt_00004   45.4   -<span style="color: #BB0000;">1.36</span>  C           0 Study-1 Group-1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> pt_00005  511      2.00  B           1 Study-1 Group-1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> pt_00006  452      0.696 B           1 Study-1 Group-1</span></span></code></pre></div>
<p>The longitudinal data has: - patient ID - time point - sum of longest
diameters (SLD) - study ID - treatment arm - observation flag</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">long_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 6</span></span></span>
<span><span class="co">#&gt;   pt        time   sld study   arm     observed</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> pt_00001     1  31.0 Study-1 Group-1 TRUE    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> pt_00002     1  27.3 Study-1 Group-1 TRUE    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> pt_00003     1  33.8 Study-1 Group-1 TRUE    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> pt_00004     1  32.5 Study-1 Group-1 TRUE    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> pt_00005     1  31.6 Study-1 Group-1 TRUE    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> pt_00006     1  30.0 Study-1 Group-1 TRUE</span></span></code></pre></div>
<p>Finally, we wrap these in the data formatting functions. Here the
mapping of the column names to the required variables happens.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">joint_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/DataJoint-class.html">DataJoint</a></span><span class="op">(</span></span>
<span>    survival <span class="op">=</span> <span class="fu"><a href="../reference/DataSurvival-class.html">DataSurvival</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">os_data</span>,</span>
<span>        formula <span class="op">=</span> <span class="fu"><a href="../reference/Surv.html">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">cov_cat</span> <span class="op">+</span> <span class="va">cov_cont</span>,</span>
<span>        subject <span class="op">=</span> <span class="st">"pt"</span>,</span>
<span>        arm <span class="op">=</span> <span class="st">"arm"</span>,</span>
<span>        study <span class="op">=</span> <span class="st">"study"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    longitudinal <span class="op">=</span> <span class="fu"><a href="../reference/DataLongitudinal-class.html">DataLongitudinal</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">long_data</span>,</span>
<span>        formula <span class="op">=</span> <span class="va">sld</span> <span class="op">~</span> <span class="va">time</span>,</span>
<span>        subject <span class="op">=</span> <span class="st">"pt"</span>,</span>
<span>        threshold <span class="op">=</span> <span class="fl">5</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="model-fitting">Model Fitting<a class="anchor" aria-label="anchor" href="#model-fitting"></a>
</h2>
<p>Now let’s have a look how we can fit the (joint) models.</p>
<div class="section level3">
<h3 id="debugging-stan-code">Debugging Stan Code<a class="anchor" aria-label="anchor" href="#debugging-stan-code"></a>
</h3>
<p>It is always possible to read out the Stan code that is contained in
the <code>JointModel</code> object, using <code><a href="../reference/write_stan.html">write_stan()</a></code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/write_stan.html">write_stan</a></span><span class="op">(</span><span class="va">simple_model</span>, file_path <span class="op">=</span> <span class="va">tmp</span><span class="op">)</span></span>
<span><span class="va">first_part</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">first_part</span>, collapse <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; functions {</span></span>
<span><span class="co">#&gt;     //</span></span>
<span><span class="co">#&gt;     // Source - base/functions.stan</span></span>
<span><span class="co">#&gt;     //</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     // Constant used in below.</span></span>
<span><span class="co">#&gt;     real neg_log_sqrt_2_pi() {</span></span>
<span><span class="co">#&gt;         return -0.9189385332046727;</span></span>
<span><span class="co">#&gt;     }</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="sampling-parameters">Sampling Parameters<a class="anchor" aria-label="anchor" href="#sampling-parameters"></a>
</h3>
<p>Finally, <code><a href="../reference/sampleStanModel.html">sampleStanModel()</a></code> is kicking off the MCMC
sampler via <code>cmdstanr</code> in the backend.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mcmc_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sampleStanModel.html">sampleStanModel</a></span><span class="op">(</span></span>
<span>    <span class="va">simple_model</span>,</span>
<span>    data <span class="op">=</span> <span class="va">joint_data</span>,</span>
<span>    iter_sampling <span class="op">=</span> <span class="fl">500</span>,</span>
<span>    iter_warmup <span class="op">=</span> <span class="fl">500</span>,</span>
<span>    chains <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    parallel_chains <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    exe_file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"local"</span>, <span class="st">"full"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; CmdStan path set to: /root/.cmdstan/cmdstan-2.32.2</span></span>
<span><span class="co">#&gt; Running MCMC with 1 chain...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Chain 1 Iteration:   1 / 1000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span>
<span><span class="co">#&gt; Chain 1 Exception: normal_lpdf: Scale parameter is 0, but must be positive! (in '/tmp/Rtmp1vF0Ip/model-5c554f2139a.stan', line 296, column 8 to line 300, column 10)</span></span>
<span><span class="co">#&gt; Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span>
<span><span class="co">#&gt; Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span>
<span><span class="co">#&gt; Chain 1</span></span>
<span><span class="co">#&gt; Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span>
<span><span class="co">#&gt; Chain 1 Exception: normal_lpdf: Scale parameter is 0, but must be positive! (in '/tmp/Rtmp1vF0Ip/model-5c554f2139a.stan', line 296, column 8 to line 300, column 10)</span></span>
<span><span class="co">#&gt; Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span>
<span><span class="co">#&gt; Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span>
<span><span class="co">#&gt; Chain 1</span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 100 / 1000 [ 10%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 200 / 1000 [ 20%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 300 / 1000 [ 30%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 400 / 1000 [ 40%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 500 / 1000 [ 50%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 501 / 1000 [ 50%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 600 / 1000 [ 60%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 700 / 1000 [ 70%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 800 / 1000 [ 80%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 900 / 1000 [ 90%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 1000 / 1000 [100%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 1 finished in 176.1 seconds.</span></span></code></pre></div>
<p>Note that <code>exe_file</code> is used to specify the location of
the compiled Stan file, e.g. relative to the current working
directory.</p>
<p>We can see that there were a couple of red warnings in the beginning
of the sampling. However, that is not of a concern because they did not
persist. After the sampling finishes, we can inspect the parameter
distributions. This is using the <code>cmdstanr</code> functions,
because the <code>results</code> element is of class
<code>CmdStanMCMC</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"lm_rs_intercept"</span>,</span>
<span>    <span class="st">"lm_rs_slope_mu"</span>,</span>
<span>    <span class="st">"lm_rs_slope_sigma"</span>,</span>
<span>    <span class="st">"lm_rs_sigma"</span>,</span>
<span>    <span class="st">"link_lm_phi"</span>,</span>
<span>    <span class="st">"sm_weibull_ph_lambda"</span>,</span>
<span>    <span class="st">"sm_weibull_ph_gamma"</span>,</span>
<span>    <span class="st">"beta_os_cov"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mcmc_results</span><span class="op">@</span><span class="va">results</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span><span class="va">vars</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: The ESS has been capped to avoid unstable estimates.</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 11 × 10</span></span></span>
<span><span class="co">#&gt;    variable       mean   median      sd     mad       q5      q95  rhat ess_bulk</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;num&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;num&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;num&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;num&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;num&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;num&gt;</span> <span style="color: #949494; font-style: italic;">&lt;num&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;num&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> lm_rs_int… 30.0     30.0     4.36<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> 4.23<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> 29.9     30.0     0.999     283.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> lm_rs_slo…  1.01     1.01    8.68<span style="color: #949494;">e</span><span style="color: #BB0000;">-3</span> 8.60<span style="color: #949494;">e</span><span style="color: #BB0000;">-3</span>  0.991    1.02    0.999    <span style="text-decoration: underline;">1</span>349.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> lm_rs_slo…  2.01     2.01    9.13<span style="color: #949494;">e</span><span style="color: #BB0000;">-3</span> 8.21<span style="color: #949494;">e</span><span style="color: #BB0000;">-3</span>  2.00     2.03    0.998     862.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> lm_rs_slo…  0.200    0.200   4.45<span style="color: #949494;">e</span><span style="color: #BB0000;">-3</span> 4.71<span style="color: #949494;">e</span><span style="color: #BB0000;">-3</span>  0.192    0.207   1.01      770.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> lm_rs_sig…  2.90     2.90    1.76<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> 1.74<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>  2.88     2.93    1.00      534.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> link_lm_p…  0.055<span style="text-decoration: underline;">7</span>   0.056<span style="text-decoration: underline;">7</span>  5.87<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> 6.11<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> -<span style="color: #BB0000;">0.039</span><span style="color: #BB0000; text-decoration: underline;">7</span>   0.151   0.999     534.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> sm_weibul…  0.003<span style="text-decoration: underline;">84</span>  0.003<span style="text-decoration: underline;">77</span> 7.13<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span> 6.53<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span>  0.002<span style="text-decoration: underline;">80</span>  0.005<span style="text-decoration: underline;">10</span> 1.01      254.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> sm_weibul…  0.967    0.966   2.47<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> 2.43<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>  0.928    1.01    1.00      316.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> beta_os_c… -<span style="color: #BB0000;">0.244</span>   -<span style="color: #BB0000;">0.241</span>   8.25<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> 8.43<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> -<span style="color: #BB0000;">0.378</span>   -<span style="color: #BB0000;">0.106</span>   0.998     844.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> beta_os_c…  0.439    0.436   7.78<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> 7.04<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>  0.305    0.571   0.998     560.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> beta_os_c…  0.291    0.290   3.13<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> 3.32<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>  0.238    0.341   1.01      699.</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: ess_tail &lt;num&gt;</span></span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Craig Gower-Page, Georgios Kazantzidis, Xiaoyan Fang, Daniel Sabanes Bove, F. Hoffmann-La Roche AG.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
