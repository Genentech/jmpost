<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="jmpost">
<title>Model Fitting • jmpost</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Model Fitting">
<meta property="og:description" content="jmpost">
<meta property="og:image" content="https://genentech.github.io/jmpost/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">jmpost</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/extending-jmpost.html">Extending jmpost</a>
    <a class="dropdown-item" href="../articles/model_fitting.html">Model Fitting</a>
    <a class="dropdown-item" href="../articles/statistical-specification.html">Statistical Specifications</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-reports">Reports</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-reports">
    <a class="dropdown-item" href="../coverage-report/">Coverage report</a>
    <a class="dropdown-item" href="../unit-test-report/">Unit test report</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/genentech/jmpost/">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Model Fitting</h1>
            
      
      
      <div class="d-none name"><code>model_fitting.Rmd</code></div>
    </div>

    
    
<p>Here we describe the basic steps of joint model fitting with
<code>{jmpost}</code>.</p>
<div class="section level2">
<h2 id="model-specification">Model Specification<a class="anchor" aria-label="anchor" href="#model-specification"></a>
</h2>
<p>Each <code>JointModel</code> needs to be specified with three
parts:</p>
<ol style="list-style-type: decimal">
<li>
<code>longitudinal</code>: The model for the longitudinal
outcomes.</li>
<li>
<code>survival</code>: The model for the survival outcomes.</li>
<li>
<code>link</code>: The link that specifies how the
<code>longitudinal</code> model parameters enter the
<code>survival</code> model.</li>
</ol>
<div class="section level3">
<h3 id="default-options">Default Options<a class="anchor" aria-label="anchor" href="#default-options"></a>
</h3>
<p>Let’s first specify a very simple joint model with:</p>
<ol style="list-style-type: decimal">
<li>A random slope model for the longitudinal outcome.</li>
<li>A Weibull proportional hazards model for the survival outcome.</li>
<li>The link between the two models is that the random slope from the
longitudinal model enters as a product with a link coefficient into the
linear predictor of the survival model.</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simple_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/JointModel-class.html">JointModel</a></span><span class="op">(</span></span>
<span>    longitudinal <span class="op">=</span> <span class="fu"><a href="../reference/LongitudinalRandomSlope-class.html">LongitudinalRandomSlope</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    survival <span class="op">=</span> <span class="fu"><a href="../reference/SurvivalWeibullPH-class.html">SurvivalWeibullPH</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    link <span class="op">=</span> <span class="fu"><a href="../reference/standard-link-user.html">linkDSLD</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note that here we use all the default options for the two models and
the link, in particular the prior distributions and the initial values
in the MCMC chain for the parameters are automatically chosen. We can
see this from the arguments of the constructors (or from the help
page):</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/args.html" class="external-link">args</a></span><span class="op">(</span><span class="va">LongitudinalRandomSlope</span><span class="op">)</span></span>
<span><span class="co">#&gt; function (intercept = prior_normal(30, 10), slope_mu = prior_normal(0, </span></span>
<span><span class="co">#&gt;     15), slope_sigma = prior_lognormal(0, 1.5), sigma = prior_lognormal(0, </span></span>
<span><span class="co">#&gt;     1.5)) </span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>So here we see that the Longitudinal Random Slope model has 4
parameters that we can define a prior for.</p>
</div>
<div class="section level3">
<h3 id="specifying-priors">Specifying Priors<a class="anchor" aria-label="anchor" href="#specifying-priors"></a>
</h3>
<p>We can alternatively also specify the prior distributions for the
parameters manually. This is important in practice to obtain a
meaningful model specification and hence converging MCMC chains that
allow to estimate the posterior distributions.</p>
<p>For the random slope model for the longitudinal outcome, we can
e.g. say:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">random_slope_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/LongitudinalRandomSlope-class.html">LongitudinalRandomSlope</a></span><span class="op">(</span></span>
<span>    intercept <span class="op">=</span> <span class="fu"><a href="../reference/prior_normal.html">prior_normal</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>    slope_mu <span class="op">=</span> <span class="fu"><a href="../reference/prior_normal.html">prior_normal</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This sets the prior for the <code>intercept</code> to be a <span class="math inline">\(N(40, 5)\)</span> distribution and the prior for
the <code>slope_mu</code> parameter to be a <span class="math inline">\(N(10, 2)\)</span> distribution.</p>
</div>
<div class="section level3">
<h3 id="separate-models">Separate Models<a class="anchor" aria-label="anchor" href="#separate-models"></a>
</h3>
<p>It is also possible to not link the longitudinal and the survival
models, by using the special <code><a href="../reference/standard-link-user.html">linkNone()</a></code> link specification.
For example,</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simple_model_no_link</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/JointModel-class.html">JointModel</a></span><span class="op">(</span></span>
<span>    longitudinal <span class="op">=</span> <span class="fu"><a href="../reference/LongitudinalRandomSlope-class.html">LongitudinalRandomSlope</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    survival <span class="op">=</span> <span class="fu"><a href="../reference/SurvivalWeibullPH-class.html">SurvivalWeibullPH</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    link <span class="op">=</span> <span class="fu"><a href="../reference/standard-link-user.html">linkNone</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>would allow to fit the two models separately, but in the same MCMC
chain.</p>
</div>
<div class="section level3">
<h3 id="single-models">Single Models<a class="anchor" aria-label="anchor" href="#single-models"></a>
</h3>
<p>It is also possible to specify only the longitudinal or the survival
model. Then these can be estimated on their own with separate MCMC
chains.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">single_longitudinal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/JointModel-class.html">JointModel</a></span><span class="op">(</span></span>
<span>    longitudinal <span class="op">=</span> <span class="fu"><a href="../reference/LongitudinalRandomSlope-class.html">LongitudinalRandomSlope</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">single_survival</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/JointModel-class.html">JointModel</a></span><span class="op">(</span></span>
<span>    survival <span class="op">=</span> <span class="fu"><a href="../reference/SurvivalWeibullPH-class.html">SurvivalWeibullPH</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="data-preparation">Data Preparation<a class="anchor" aria-label="anchor" href="#data-preparation"></a>
</h2>
<p>Before we can fit the models, we need to prepare the data in the
right format.</p>
<div class="section level3">
<h3 id="simulating-data">Simulating Data<a class="anchor" aria-label="anchor" href="#simulating-data"></a>
</h3>
<p>Here we start from a simulated data set.</p>
<ul>
<li>We assign 50 patients each to the two treatment arms.</li>
<li>We use a time grid from 1 to 2000, e.g. specifying the days after
randomization.</li>
<li>We use an exponentially distributed censoring time with mean of 9000
days.</li>
<li>We use a categorical covariate with three levels A, B and C in the
overall survival model, drawn uniformly from the three levels. (Note
that this is hardcoded at the moment, so the levels need to be A, B,
C.)</li>
<li>We use another continuous covariate in the overall survival model
generated from a standard normal distribution, with coefficient
0.3.</li>
<li>For the longitudinal outcome, we draw the values from a random slope
model with the given parameters.</li>
<li>For the survival outcome, we draw the true value from a Weibull
model. Note that it is fairly easy to put here another choice, you just
need to specify a function of <code>time</code> returning the log
baseline hazard under the given survival model.</li>
</ul>
<p>So let’s run the code for that:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">129</span><span class="op">)</span></span>
<span><span class="va">sim_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SimJointData-class.html">SimJointData</a></span><span class="op">(</span></span>
<span>    design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="../reference/SimGroup-class.html">SimGroup</a></span><span class="op">(</span><span class="fl">50</span>, <span class="st">"Arm-A"</span>, <span class="st">"Study-X"</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="../reference/SimGroup-class.html">SimGroup</a></span><span class="op">(</span><span class="fl">50</span>, <span class="st">"Arm-B"</span>, <span class="st">"Study-X"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    longitudinal <span class="op">=</span> <span class="fu"><a href="../reference/SimLongitudinalRandomSlope-class.html">SimLongitudinalRandomSlope</a></span><span class="op">(</span></span>
<span>        times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">150</span>, <span class="fl">200</span>, <span class="fl">250</span>, <span class="fl">300</span><span class="op">)</span>,</span>
<span>        intercept <span class="op">=</span> <span class="fl">30</span>,</span>
<span>        slope_mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>        slope_sigma <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>        sigma <span class="op">=</span> <span class="fl">20</span>,</span>
<span>        link_dsld <span class="op">=</span> <span class="fl">0.1</span></span>
<span>    <span class="op">)</span>,</span>
<span>    survival <span class="op">=</span> <span class="fu"><a href="../reference/SimSurvivalWeibullPH.html">SimSurvivalWeibullPH</a></span><span class="op">(</span></span>
<span>        lambda <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">300</span>,</span>
<span>        gamma <span class="op">=</span> <span class="fl">0.97</span>,</span>
<span>        time_max <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>        time_step <span class="op">=</span> <span class="fl">1</span>,</span>
<span>        lambda_cen <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">9000</span>,</span>
<span>        beta_cat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>            <span class="st">"A"</span> <span class="op">=</span> <span class="fl">0</span>,</span>
<span>            <span class="st">"B"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span>,</span>
<span>            <span class="st">"C"</span> <span class="op">=</span> <span class="fl">0.5</span></span>
<span>        <span class="op">)</span>,</span>
<span>        beta_cont <span class="op">=</span> <span class="fl">0.3</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We might get a message here that a few patients did not die before
the day 2000, but this is not of concern. Basically it just gives us a
feeling of how many survival events are included in the data set.</p>
</div>
<div class="section level3">
<h3 id="formatting-data">Formatting Data<a class="anchor" aria-label="anchor" href="#formatting-data"></a>
</h3>
<p>Next we bring the data into the right format.</p>
<p>We start with extracting data into individual data sets, and then
reducing the longitudinal data to specific time points.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">os_data</span> <span class="op">&lt;-</span> <span class="va">sim_data</span><span class="op">@</span><span class="va">survival</span></span>
<span><span class="va">long_data</span> <span class="op">&lt;-</span> <span class="va">sim_data</span><span class="op">@</span><span class="va">longitudinal</span></span></code></pre></div>
<p>Let’s have a quick look at the format:</p>
<p>The survival data has:</p>
<ul>
<li>patient ID</li>
<li>time point</li>
<li>continuous covariate value</li>
<li>categorical covariate level</li>
<li>event indicator (1 for observed, 0 for censored)</li>
<li>study ID</li>
<li>treatment arm</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">os_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 x 7</span></span></span>
<span><span class="co">#&gt;   pt     study   arm    time event cov_cont cov_cat</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> pt_001 Study-X Arm-A    35     1   -<span style="color: #BB0000;">1.12</span>  B      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> pt_002 Study-X Arm-A    17     1   -<span style="color: #BB0000;">0.990</span> C      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> pt_003 Study-X Arm-A   876     1   -<span style="color: #BB0000;">1.37</span>  C      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> pt_004 Study-X Arm-A   100     1   -<span style="color: #BB0000;">1.36</span>  C      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> pt_005 Study-X Arm-A     9     1    2.00  B      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> pt_006 Study-X Arm-A   122     1    0.696 B</span></span></code></pre></div>
<p>The longitudinal data has:</p>
<ul>
<li>patient ID</li>
<li>time point</li>
<li>sum of longest diameters (SLD)</li>
<li>study ID</li>
<li>treatment arm</li>
<li>observation flag</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">long_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 x 6</span></span></span>
<span><span class="co">#&gt;   pt     arm   study    time   sld observed</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> pt_001 Arm-A Study-X     1  23.4 TRUE    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> pt_001 Arm-A Study-X    50 108.  FALSE   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> pt_001 Arm-A Study-X   100 137.  FALSE   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> pt_001 Arm-A Study-X   150 141.  FALSE   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> pt_001 Arm-A Study-X   200 220.  FALSE   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> pt_001 Arm-A Study-X   250 325.  FALSE</span></span></code></pre></div>
<p>Finally, we wrap these in the data formatting functions. Here the
mapping of the column names to the required variables happens. This
means that in our applications we don’t have to use the same variable
names as seen above, but we can use custom names and then apply the
mapping here.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">joint_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/DataJoint-class.html">DataJoint</a></span><span class="op">(</span></span>
<span>    subject <span class="op">=</span> <span class="fu"><a href="../reference/DataSubject-class.html">DataSubject</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">os_data</span>,</span>
<span>        subject <span class="op">=</span> <span class="st">"pt"</span>,</span>
<span>        arm <span class="op">=</span> <span class="st">"arm"</span>,</span>
<span>        study <span class="op">=</span> <span class="st">"study"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    survival <span class="op">=</span> <span class="fu"><a href="../reference/DataSurvival-class.html">DataSurvival</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">os_data</span>,</span>
<span>        formula <span class="op">=</span> <span class="fu"><a href="../reference/Surv.html">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">cov_cat</span> <span class="op">+</span> <span class="va">cov_cont</span></span>
<span>    <span class="op">)</span>,</span>
<span>    longitudinal <span class="op">=</span> <span class="fu"><a href="../reference/DataLongitudinal-class.html">DataLongitudinal</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">long_data</span>,</span>
<span>        formula <span class="op">=</span> <span class="va">sld</span> <span class="op">~</span> <span class="va">time</span>,</span>
<span>        threshold <span class="op">=</span> <span class="fl">5</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="model-fitting">Model Fitting<a class="anchor" aria-label="anchor" href="#model-fitting"></a>
</h2>
<p>Now let’s have a look how we can fit the (joint) models.</p>
<div class="section level3">
<h3 id="debugging-stan-code">Debugging Stan Code<a class="anchor" aria-label="anchor" href="#debugging-stan-code"></a>
</h3>
<p>It is always possible to read out the Stan code that is contained in
the <code>JointModel</code> object, using <code><a href="../reference/write_stan.html">write_stan()</a></code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/write_stan.html">write_stan</a></span><span class="op">(</span><span class="va">simple_model</span>, file_path <span class="op">=</span> <span class="va">tmp</span><span class="op">)</span></span>
<span><span class="va">first_part</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">first_part</span>, collapse <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; functions {</span></span>
<span><span class="co">#&gt;     //</span></span>
<span><span class="co">#&gt;     // Source - base/functions.stan</span></span>
<span><span class="co">#&gt;     //</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     // Constant used in below.</span></span>
<span><span class="co">#&gt;     real neg_log_sqrt_2_pi() {</span></span>
<span><span class="co">#&gt;         return -0.9189385332046727;</span></span>
<span><span class="co">#&gt;     }</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="sampling-parameters">Sampling Parameters<a class="anchor" aria-label="anchor" href="#sampling-parameters"></a>
</h3>
<p>Finally, <code><a href="../reference/sampleStanModel.html">sampleStanModel()</a></code> is kicking off the MCMC
sampler via <code>cmdstanr</code> in the backend. Note that in practice
you would increase the number of warm-up and sampling iterations.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mcmc_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sampleStanModel.html">sampleStanModel</a></span><span class="op">(</span></span>
<span>    <span class="va">simple_model</span>,</span>
<span>    data <span class="op">=</span> <span class="va">joint_data</span>,</span>
<span>    iter_sampling <span class="op">=</span> <span class="fl">500</span>,</span>
<span>    iter_warmup <span class="op">=</span> <span class="fl">500</span>,</span>
<span>    chains <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    parallel_chains <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Running MCMC with 1 chain...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Chain 1 Iteration:   1 / 1000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span>
<span><span class="co">#&gt; Chain 1 Exception: gamma_lpdf: Random variable is inf, but must be positive finite! (in '/tmp/RtmpxNlOLN/model-144b24b049ec.stan', line 483, column 4 to column 100)</span></span>
<span><span class="co">#&gt; Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span>
<span><span class="co">#&gt; Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span>
<span><span class="co">#&gt; Chain 1</span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 100 / 1000 [ 10%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 200 / 1000 [ 20%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 300 / 1000 [ 30%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 400 / 1000 [ 40%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 500 / 1000 [ 50%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 501 / 1000 [ 50%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 600 / 1000 [ 60%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 700 / 1000 [ 70%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 800 / 1000 [ 80%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 900 / 1000 [ 90%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 1000 / 1000 [100%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 1 finished in 6.5 seconds.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="convergence-checks">Convergence checks<a class="anchor" aria-label="anchor" href="#convergence-checks"></a>
</h3>
<p>After the sampling finishes, we can inspect the parameter
distributions. This is using the <code>cmdstanr</code> functions,
because the <code>results</code> element is of class
<code>CmdStanMCMC</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"lm_rs_intercept"</span>,</span>
<span>    <span class="st">"lm_rs_slope_mu"</span>,</span>
<span>    <span class="st">"lm_rs_slope_sigma"</span>,</span>
<span>    <span class="st">"lm_rs_sigma"</span>,</span>
<span>    <span class="st">"link_dsld"</span>,</span>
<span>    <span class="st">"sm_weibull_ph_lambda"</span>,</span>
<span>    <span class="st">"sm_weibull_ph_gamma"</span>,</span>
<span>    <span class="st">"beta_os_cov"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/as.CmdStanMCMC.html">as.CmdStanMCMC</a></span><span class="op">(</span><span class="va">mcmc_results</span><span class="op">)</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span><span class="va">vars</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 11 x 10</span></span></span>
<span><span class="co">#&gt;    variable        mean   median      sd     mad       q5     q95  rhat ess_bulk</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> lm_rs_inte~ 27.6     27.6     1.33    1.17    25.3     29.8    0.999     165.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> lm_rs_slop~  1.02     1.02    0.027<span style="text-decoration: underline;">4</span>  0.025<span style="text-decoration: underline;">0</span>   0.973    1.07   0.999     971.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> lm_rs_slop~  1.96     1.96    0.030<span style="text-decoration: underline;">2</span>  0.028<span style="text-decoration: underline;">2</span>   1.91     2.01   1.01      449.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> lm_rs_slop~  0.205    0.204   0.016<span style="text-decoration: underline;">4</span>  0.017<span style="text-decoration: underline;">3</span>   0.179    0.233  1.00      974.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> lm_rs_sigma 19.2     19.2     0.579   0.570   18.3     20.1    1.00      791.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> link_dsld   -<span style="color: #BB0000;">0.066</span><span style="color: #BB0000; text-decoration: underline;">0</span>  -<span style="color: #BB0000;">0.065</span><span style="color: #BB0000; text-decoration: underline;">7</span>  0.206   0.203   -<span style="color: #BB0000;">0.403</span>    0.263  1.01      640.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> sm_weibull~  0.010<span style="text-decoration: underline;">3</span>   0.008<span style="text-decoration: underline;">90</span> 0.006<span style="text-decoration: underline;">38</span> 0.004<span style="text-decoration: underline;">66</span>  0.003<span style="text-decoration: underline;">25</span>  0.022<span style="text-decoration: underline;">3</span> 0.999     426.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> sm_weibull~  0.886    0.881   0.078<span style="text-decoration: underline;">0</span>  0.079<span style="text-decoration: underline;">2</span>   0.766    1.02   0.999     583.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> beta_os_co~  0.002<span style="text-decoration: underline;">43</span>  0.013<span style="text-decoration: underline;">6</span>  0.259   0.268   -<span style="color: #BB0000;">0.443</span>    0.464  1.01      642.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> beta_os_co~  0.337    0.353   0.263   0.264   -<span style="color: #BB0000;">0.137</span>    0.752  0.998     666.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> beta_os_co~  0.370    0.371   0.119   0.108    0.168    0.559  1.00      759.</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># i 1 more variable: ess_tail &lt;dbl&gt;</span></span></span></code></pre></div>
<p>We can already see here from the <code>rhat</code> statistic whether
the MCMC sampler converged - values close to 1 indicate convergence,
while values larger than 1 indicate divergence.</p>
<p>In general, convergence is sensitive to the choice of:</p>
<ul>
<li>Priors</li>
<li>Initial values</li>
<li>Sufficient warm-up iterations</li>
</ul>
<p>If you don’t achieve convergence, then play around with different
choices of the above.</p>
</div>
</div>
<div class="section level2">
<h2 id="plotting">Plotting<a class="anchor" aria-label="anchor" href="#plotting"></a>
</h2>
<p>We can now proceed towards investigating the results of the MCMC
chain with plots.</p>
<div class="section level3">
<h3 id="trace-plots">Trace plots<a class="anchor" aria-label="anchor" href="#trace-plots"></a>
</h3>
<p>Using the <code>draws()</code> method on the <code>results</code>
element, we can extract the samples in a format that is understood by
<code>bayesplot</code>. We can e.g. look at some simple trace plots:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vars_draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as.CmdStanMCMC.html">as.CmdStanMCMC</a></span><span class="op">(</span><span class="va">mcmc_results</span><span class="op">)</span><span class="op">$</span><span class="fu">draws</span><span class="op">(</span><span class="va">vars</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/bayesplot/" class="external-link">bayesplot</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; This is bayesplot version 1.11.1</span></span>
<span><span class="co">#&gt; - Online documentation and vignettes at mc-stan.org/bayesplot</span></span>
<span><span class="co">#&gt; - bayesplot theme set to bayesplot::theme_default()</span></span>
<span><span class="co">#&gt;    * Does _not_ affect other ggplot2 plots</span></span>
<span><span class="co">#&gt;    * See ?bayesplot_theme_set for details on theme setting</span></span>
<span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-traces.html" class="external-link">mcmc_trace</a></span><span class="op">(</span><span class="va">vars_draws</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-1-1.png" width="576"></p>
</div>
<div class="section level3">
<h3 id="longitudinal-fit-plots">Longitudinal fit plots<a class="anchor" aria-label="anchor" href="#longitudinal-fit-plots"></a>
</h3>
<p>Using the <code>longitudinal()</code> method we can extract the
longitudinal fit samples from the result, and then plot them for all
patients or those that we are interested in. For illustration, we will
plot here the first 10 patients:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">selected_patients</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">os_data</span><span class="op">$</span><span class="va">pt</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">long_quantities</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/LongitudinalQuantities-class.html">LongitudinalQuantities</a></span><span class="op">(</span></span>
<span>    <span class="va">mcmc_results</span>,</span>
<span>    grid <span class="op">=</span> <span class="fu"><a href="../reference/Grid-Functions.html">GridFixed</a></span><span class="op">(</span></span>
<span>        subjects <span class="op">=</span> <span class="va">selected_patients</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">long_quantities</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;    group time  values</span></span>
<span><span class="co">#&gt; 1 pt_001    0 27.7402</span></span>
<span><span class="co">#&gt; 2 pt_001    0 25.7129</span></span>
<span><span class="co">#&gt; 3 pt_001    0 29.7628</span></span>
<span><span class="co">#&gt; 4 pt_001    0 28.9944</span></span>
<span><span class="co">#&gt; 5 pt_001    0 27.8322</span></span>
<span><span class="co">#&gt; 6 pt_001    0 27.2914</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">long_quantities</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;    group time  median    lower    upper</span></span>
<span><span class="co">#&gt; 1 pt_001    0 27.6192 25.02362 30.20194</span></span>
<span><span class="co">#&gt; 2 pt_002    0 27.6192 25.02362 30.20194</span></span>
<span><span class="co">#&gt; 3 pt_003    0 27.6192 25.02362 30.20194</span></span>
<span><span class="co">#&gt; 4 pt_004    0 27.6192 25.02362 30.20194</span></span>
<span><span class="co">#&gt; 5 pt_005    0 27.6192 25.02362 30.20194</span></span>
<span><span class="co">#&gt; 6 pt_006    0 27.6192 25.02362 30.20194</span></span>
<span><span class="fu"><a href="../reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">long_quantities</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-2-1.png" width="576"></p>
</div>
<div class="section level3">
<h3 id="survival-fit-plots">Survival fit plots<a class="anchor" aria-label="anchor" href="#survival-fit-plots"></a>
</h3>
<p>And using the <code><a href="../reference/SurvivalQuantities-class.html">SurvivalQuantities()</a></code> method we can do the
same for the estimated survival functions.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv_quantities</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SurvivalQuantities-class.html">SurvivalQuantities</a></span><span class="op">(</span></span>
<span>    <span class="va">mcmc_results</span>,</span>
<span>    grid <span class="op">=</span> <span class="fu"><a href="../reference/Grid-Functions.html">GridFixed</a></span><span class="op">(</span></span>
<span>        subjects <span class="op">=</span> <span class="va">selected_patients</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">surv_quantities</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;    group time values</span></span>
<span><span class="co">#&gt; 1 pt_001    0      1</span></span>
<span><span class="co">#&gt; 2 pt_001    0      1</span></span>
<span><span class="co">#&gt; 3 pt_001    0      1</span></span>
<span><span class="co">#&gt; 4 pt_001    0      1</span></span>
<span><span class="co">#&gt; 5 pt_001    0      1</span></span>
<span><span class="co">#&gt; 6 pt_001    0      1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">surv_quantities</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;    group time median lower upper</span></span>
<span><span class="co">#&gt; 1 pt_001    0      1     1     1</span></span>
<span><span class="co">#&gt; 2 pt_002    0      1     1     1</span></span>
<span><span class="co">#&gt; 3 pt_003    0      1     1     1</span></span>
<span><span class="co">#&gt; 4 pt_004    0      1     1     1</span></span>
<span><span class="co">#&gt; 5 pt_005    0      1     1     1</span></span>
<span><span class="co">#&gt; 6 pt_006    0      1     1     1</span></span>
<span><span class="fu"><a href="../reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">surv_quantities</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-3-1.png" width="576"></p>
<p>We can also aggregate the estimated survival curves from groups of
patients, using the corresponding method.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv_quantities</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SurvivalQuantities-class.html">SurvivalQuantities</a></span><span class="op">(</span></span>
<span>    <span class="va">mcmc_results</span>,</span>
<span>    grid <span class="op">=</span> <span class="fu"><a href="../reference/Grid-Functions.html">GridGrouped</a></span><span class="op">(</span></span>
<span>        groups <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">os_data</span><span class="op">$</span><span class="va">pt</span>, <span class="va">os_data</span><span class="op">$</span><span class="va">arm</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">surv_quantities</span>, add_km <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-4-1.png" width="576"></p>
</div>
<div class="section level3">
<h3 id="predicting-survival-quantities-for-hypothetical-subjects">Predicting Survival Quantities for Hypothetical Subjects<a class="anchor" aria-label="anchor" href="#predicting-survival-quantities-for-hypothetical-subjects"></a>
</h3>
<p>The <code><a href="../reference/SurvivalQuantities-class.html">SurvivalQuantities()</a></code> method can also be used to
predict survival quantities for hypothetical subjects with any arbitrary
covariate and longitudinal model parameter values. This is done via
passing a <code><a href="../reference/Grid-Functions.html">GridPrediction()</a></code> object to the method where the
<code>newdata</code> and <code>params</code> arguments are used to
specify the desired values for the covariates and longitudinal model
parameters respectively. For example below we use these functions to
predict the survival distribution for a hypothetical subject:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv_quantities</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SurvivalQuantities-class.html">SurvivalQuantities</a></span><span class="op">(</span></span>
<span>    <span class="va">mcmc_results</span>,</span>
<span>    grid <span class="op">=</span> <span class="fu"><a href="../reference/Grid-Functions.html">GridPrediction</a></span><span class="op">(</span></span>
<span>        times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">800</span>, by <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>        newdata <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>            cov_cat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>,</span>
<span>            cov_cont <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.2</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>            intercept <span class="op">=</span> <span class="fl">40</span>,</span>
<span>            slope <span class="op">=</span> <span class="fl">0.05</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">surv_quantities</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>The exact names that are required for the <code>params</code>
argument (i.e. the longitudinal model parameters) can be found by
running <code><a href="../reference/getPredictionNames.html">getPredictionNames()</a></code> on the longitudinal model
object. For example:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getPredictionNames.html">getPredictionNames</a></span><span class="op">(</span><span class="fu"><a href="../reference/LongitudinalGSF-class.html">LongitudinalGSF</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "b"   "s"   "g"   "phi"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="brier-score">Brier Score<a class="anchor" aria-label="anchor" href="#brier-score"></a>
</h3>
<p>The <code><a href="../reference/brierScore.html">brierScore()</a></code> method can be used to extract the Brier
Scores (predictive performance measure) from our
<code>SurvivalQuantities</code> object.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sq</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SurvivalQuantities-class.html">SurvivalQuantities</a></span><span class="op">(</span></span>
<span>    <span class="va">mcmc_results</span>,</span>
<span>    grid <span class="op">=</span> <span class="fu"><a href="../reference/Grid-Functions.html">GridFixed</a></span><span class="op">(</span>times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">400</span>, <span class="fl">800</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"surv"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/brierScore.html">brierScore</a></span><span class="op">(</span><span class="va">sq</span><span class="op">)</span></span>
<span><span class="co">#&gt;          1         50        100        400        800 </span></span>
<span><span class="co">#&gt; 0.01951071 0.17188865 0.23731161 0.14918905 0.06123174</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="initial-values">Initial Values<a class="anchor" aria-label="anchor" href="#initial-values"></a>
</h3>
<p>By default <code>jmpost</code> will set the initial values for all
parameters to be a random value drawn from the prior distribution that
has been shrunk towards the mean of said distribution e.g. for a
<code>prior_normal(4, 2)</code> the initial value for each chain will
be:</p>
<pre><code><span><span class="fl">4</span> <span class="op">*</span> <span class="va">shrinkage_factor</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">shrinkage_factor</span><span class="op">)</span></span></code></pre>
<p>Note that the shrinkage factor is set to 0.5 by default and can be
changed via the <code>jmpost.prior_shrinkage</code> option e.g.</p>
<pre><code><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="st">"jmpost.prior_shrinkage"</span> <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span></code></pre>
<p>If you wish to manually specify the initial values you can do so via
the <code><a href="../reference/initialValues.html">initialValues()</a></code> function. For example:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">joint_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/JointModel-class.html">JointModel</a></span><span class="op">(</span></span>
<span>    longitudinal <span class="op">=</span> <span class="fu"><a href="../reference/LongitudinalRandomSlope-class.html">LongitudinalRandomSlope</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    survival <span class="op">=</span> <span class="fu"><a href="../reference/SurvivalExponential-class.html">SurvivalExponential</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    link <span class="op">=</span> <span class="fu"><a href="../reference/standard-link-user.html">linkNone</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">initial_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/initialValues.html">initialValues</a></span><span class="op">(</span><span class="va">joint_model</span>, n_chains <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">initial_values</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">lm_rs_intercept</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">initial_values</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">lm_rs_intercept</span> <span class="op">&lt;-</span> <span class="fl">0.3</span></span>
<span></span>
<span><span class="va">mcmc_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sampleStanModel.html">sampleStanModel</a></span><span class="op">(</span></span>
<span>    <span class="va">joint_model</span>,</span>
<span>    data <span class="op">=</span> <span class="fu"><a href="../reference/DataJoint-class.html">DataJoint</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span>,</span>
<span>    init <span class="op">=</span> <span class="va">initial_values</span>,</span>
<span>    chains <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note the following: - <code><a href="../reference/initialValues.html">initialValues()</a></code> will return a list
of lists where each sublist contains the initial values for the
corresponding chain index. - <code><a href="../reference/initialValues.html">initialValues()</a></code> by default
just returns 1 initial value for each parameter; the
<code><a href="../reference/sampleStanModel.html">sampleStanModel()</a></code> function will then broadcast this number
as many times as required e.g. if you have 3 covariates in your survival
model then the initial value for the Beta coeficient will be repeated 3
times. If however you want to specify individual initial values for each
covariate you can do so by passing in a vector of the same length as the
number of covariates. - <code><a href="../reference/initialValues.html">initialValues()</a></code> will not check if
the proposed values are valid for constrained parameters. That is, if
you are using a <code>prior_cauchy(0, 1)</code> prior for a parameter
that should be <code>&gt;0</code> then you will need to manually set the
initial value (as described above) to ensure that it is a valid
value.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Craig Gower-Page, Georgios Kazantzidis, Daniel Sabanes Bove, Xiaoyan Fang, Francois Mercier, Isaac Gravestock, F. Hoffmann-La Roche AG.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
