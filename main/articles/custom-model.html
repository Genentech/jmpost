<!DOCTYPE html>
<!-- Generated by pkgdown + https://github.com/insightsengineering/r-pkgdown-multiversion -->
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Fitting a Custom Longitudinal Model • jmpost</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fitting a Custom Longitudinal Model">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">jmpost</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/custom-model.html">Fitting a Custom Longitudinal Model</a></li>
    <li><a class="dropdown-item" href="../articles/extending-jmpost.html">Extending jmpost</a></li>
    <li><a class="dropdown-item" href="../articles/model_fitting.html">Model Fitting</a></li>
    <li><a class="dropdown-item" href="../articles/statistical-specification.html">Statistical Specifications</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-reports" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Reports</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-reports">
<li><a class="dropdown-item" href="../coverage-report/">Coverage report</a></li>
    <li><a class="dropdown-item" href="../unit-test-report/">Unit test report</a></li>
  </ul>
</li>
      <div><li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-versions">Versions</a>
    <div class="dropdown-menu" aria-labelledby="dropdown-versions">
    <a class="dropdown-item" data-toggle="tooltip" title="" href="https://Genentech.github.io/jmpost/main">main</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://Genentech.github.io/jmpost/latest-tag">latest-tag</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://Genentech.github.io/jmpost/v0.0.1">v0.0.1</a>
</div>
</li></div>
</ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/genentech/jmpost/"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Fitting a Custom Longitudinal Model</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Genentech/jmpost/blob/main/vignettes/custom-model.Rmd" class="external-link"><code>vignettes/custom-model.Rmd</code></a></small>
      <div class="d-none name"><code>custom-model.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette shows a complete example for how to fit a custom
longitudinal model. Note that full details for the various different
interfaces can be found in the “Extending jmpost” vignette. This example
implements the Wang, Sung et al. 2009 mixed exponential decay and linear
growth model along with an exponential survival model. In particular the
following model will be implemented:</p>
<p><strong>Longitudinal Model</strong>:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>y</mi><mi>i</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><mi>i</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mspace width="0.222em"></mspace><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>μ</mi><mi>i</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msub><mi>b</mi><mi>i</mi></msub><msup><mi>e</mi><mrow><mi>−</mi><msub><mi>s</mi><mi>i</mi></msub><mi>t</mi></mrow></msup><mo>+</mo><msub><mi>g</mi><mi>i</mi></msub><mi>t</mi></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>b</mi><mi>i</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><mtext mathvariant="normal">LogNormal</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><mi>b</mi></msub><mo>,</mo><mspace width="0.222em"></mspace><msub><mi>σ</mi><mi>b</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>s</mi><mi>i</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><mtext mathvariant="normal">LogNormal</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><mi>s</mi></msub><mo>,</mo><mspace width="0.222em"></mspace><msub><mi>σ</mi><mi>s</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>g</mi><mi>i</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><mtext mathvariant="normal">LogNormal</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><mi>g</mi></msub><mo>,</mo><mspace width="0.222em"></mspace><msub><mi>σ</mi><mi>g</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
y_{i}(t) &amp;\sim N\left(\mu_i(t),\ \sigma^2\right) \\ \\
\mu_i(t) &amp;= b_i e^{-s_it} + g_i t  \\ \\
b_i &amp;\sim \text{LogNormal}(\mu_b,\ \sigma_b) \\
s_i &amp;\sim \text{LogNormal}(\mu_s,\ \sigma_s) \\
g_i &amp;\sim \text{LogNormal}(\mu_g,\ \sigma_g) \\
\end{align}
</annotation></semantics></math></p>
<p>Where: *
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
is the subject index *
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">y_{i}(t)</annotation></semantics></math>
is the observed tumour size measurement for subject
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
*
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>i</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mu_i(t)</annotation></semantics></math>
is the expected tumour size measurement for subject
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
*
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>b</mi><mi>i</mi></msub><annotation encoding="application/x-tex">b_i</annotation></semantics></math>
is the subject baseline tumour size measurement *
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>s</mi><mi>i</mi></msub><annotation encoding="application/x-tex">s_i</annotation></semantics></math>
is the subject kinetics shrinkage parameter *
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>g</mi><mi>i</mi></msub><annotation encoding="application/x-tex">g_i</annotation></semantics></math>
is the subject kinetics tumour growth parameter *
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>μ</mi><mi>θ</mi></msub><annotation encoding="application/x-tex">\mu_{\theta}</annotation></semantics></math>
is the population mean for parameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>θ</mi><annotation encoding="application/x-tex">\theta</annotation></semantics></math>
*
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ω</mi><mi>θ</mi></msub><annotation encoding="application/x-tex">\omega_{\theta}</annotation></semantics></math>
is the population standard deviation for parameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>θ</mi><annotation encoding="application/x-tex">\theta</annotation></semantics></math>.</p>
<p><strong>Survival Model</strong>:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>h</mi><mi>i</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>λ</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>X</mi><mi>i</mi></msub><mi>β</mi><mo>+</mo><mi>G</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>∣</mo><msub><mi>b</mi><mi>i</mi></msub><mo>,</mo><msub><mi>s</mi><mi>i</mi></msub><mo>,</mo><msub><mi>g</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\log(h_i(t)) = \log(\lambda_0) + X_i \beta + G(t \mid b_i, s_i, g_i) 
</annotation></semantics></math></p>
<p>Where:</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>λ</mi><mn>0</mn></msub><annotation encoding="application/x-tex">\lambda_0</annotation></semantics></math>
is the baseline hazard rate. This is because for this example we are
using an exponential survival model
e.g. <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>λ</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">h_0(t) = \lambda_0</annotation></semantics></math>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
is the event time</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>.</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">G(.)</annotation></semantics></math>
is a link function that maps the subjects tumour growth parameters to a
contribution to the log-hazard function</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mi>i</mi></msub><annotation encoding="application/x-tex">X_i</annotation></semantics></math>
is the subjects covariate design matrix</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
is the corresponding coefficients vector to scale the design matrix
covariates contribution to the log-hazard function</li>
</ul>
<p>For this example we will just consider the derivative of the growth
function as the link function, e.g.
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>∣</mo><msub><mi>b</mi><mi>i</mi></msub><mo>,</mo><msub><mi>s</mi><mi>i</mi></msub><mo>,</mo><msub><mi>g</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>−</mi><msub><mi>s</mi><mi>i</mi></msub><msub><mi>b</mi><mi>i</mi></msub><msup><mi>e</mi><mrow><mi>−</mi><msub><mi>s</mi><mi>i</mi></msub><mi>t</mi></mrow></msup><mo>+</mo><msub><mi>g</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">
G(t \mid b_i, s_i, g_i) = -s_i b_i e^{-s_i t} + g_i
</annotation></semantics></math></p>
<p>To keep the example simple, a number of features that have been
implemented in the package’s<br>
internal models will be skipped; you may wish to consider adding these
if implementing this model in a real project. In particular the
following have been omitted from this example:</p>
<ul>
<li>Handling for censored observations (e.g. observations that are below
the limit of quantification)</li>
<li>Separate populations per study / arm</li>
<li>Non-centred parameterisation for the hierarchical parameters (this
parameterisation leads to better performance if you have small numbers
of observations per each subject).</li>
<li>Handling negative observation time (e.g. observations that are taken
before the start of the study)</li>
</ul>
<p>For reference the following libraries will be used during this
example:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://genentech.github.io/jmpost/">jmpost</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Registered S3 methods overwritten by 'ggpp':</span></span>
<span><span class="co">#&gt;   method                  from   </span></span>
<span><span class="co">#&gt;   heightDetails.titleGrob ggplot2</span></span>
<span><span class="co">#&gt;   widthDetails.titleGrob  ggplot2</span></span>
<span><span class="co">#&gt; CmdStan path set to: /root/.cmdstan/cmdstan-2.36.0</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/loo/" class="external-link">loo</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; This is loo version 2.8.0</span></span>
<span><span class="co">#&gt; - Online documentation and vignettes at mc-stan.org/loo</span></span>
<span><span class="co">#&gt; - As of v2.0.0 loo defaults to 1 core but we recommend using as many as possible. Use the 'cores' argument or set options(mc.cores = NUM_CORES) for an entire session.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="generating-simulated-data">Generating Simulated Data<a class="anchor" aria-label="anchor" href="#generating-simulated-data"></a>
</h2>
<p>In order to be confident that our model is working correctly we will
first generate some simulated data. This will allow us to compare the
true parameter values with the estimated parameter values. This can be
done using the <code>SimJointData</code> constructor function as
follows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define our simulation parameters + object</span></span>
<span><span class="va">SimWang</span> <span class="op">&lt;-</span> <span class="kw">setClass</span><span class="op">(</span></span>
<span>    <span class="st">"SimWang"</span>,</span>
<span>    contains <span class="op">=</span> <span class="st">"SimLongitudinal"</span>,</span>
<span>    slots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        times <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        mu_b <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        mu_s <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        mu_g <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        omega_b <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        omega_s <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        omega_g <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        sigma <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        link_dsld <span class="op">=</span> <span class="st">"numeric"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Method to generate individual subjects parameters from the hierarchical distributions</span></span>
<span><span class="va">sampleSubjects.SimWang</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">subjects_df</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">nsub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">subjects_df</span><span class="op">)</span></span>
<span>    <span class="va">subjects_df</span><span class="op">$</span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="va">nsub</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">object</span><span class="op">@</span><span class="va">mu_b</span><span class="op">)</span>, <span class="va">object</span><span class="op">@</span><span class="va">omega_b</span><span class="op">)</span></span>
<span>    <span class="va">subjects_df</span><span class="op">$</span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="va">nsub</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">object</span><span class="op">@</span><span class="va">mu_s</span><span class="op">)</span>, <span class="va">object</span><span class="op">@</span><span class="va">omega_s</span><span class="op">)</span></span>
<span>    <span class="va">subjects_df</span><span class="op">$</span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="va">nsub</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">object</span><span class="op">@</span><span class="va">mu_g</span><span class="op">)</span>, <span class="va">object</span><span class="op">@</span><span class="va">omega_g</span><span class="op">)</span></span>
<span>    <span class="va">subjects_df</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Method to generate observations for each individual subject</span></span>
<span><span class="va">sampleObservations.SimWang</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">times_df</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">nobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">times_df</span><span class="op">)</span></span>
<span>    <span class="va">calc_mu</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span>, <span class="va">b</span>, <span class="va">s</span>, <span class="va">g</span><span class="op">)</span> <span class="va">b</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">s</span> <span class="op">*</span> <span class="va">time</span><span class="op">)</span> <span class="op">+</span> <span class="va">g</span> <span class="op">*</span> <span class="va">time</span></span>
<span>    <span class="va">calc_dsld</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span>, <span class="va">b</span>, <span class="va">s</span>, <span class="va">g</span><span class="op">)</span> <span class="op">-</span><span class="va">s</span> <span class="op">*</span> <span class="va">b</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">s</span> <span class="op">*</span> <span class="va">time</span><span class="op">)</span> <span class="op">+</span> <span class="va">g</span></span>
<span></span>
<span>    <span class="va">times_df</span><span class="op">$</span><span class="va">mu_sld</span> <span class="op">&lt;-</span> <span class="fu">calc_mu</span><span class="op">(</span><span class="va">times_df</span><span class="op">$</span><span class="va">time</span>, <span class="va">times_df</span><span class="op">$</span><span class="va">b</span>, <span class="va">times_df</span><span class="op">$</span><span class="va">s</span>, <span class="va">times_df</span><span class="op">$</span><span class="va">g</span><span class="op">)</span></span>
<span>    <span class="va">times_df</span><span class="op">$</span><span class="va">dsld</span> <span class="op">&lt;-</span> <span class="fu">calc_dsld</span><span class="op">(</span><span class="va">times_df</span><span class="op">$</span><span class="va">time</span>, <span class="va">times_df</span><span class="op">$</span><span class="va">b</span>, <span class="va">times_df</span><span class="op">$</span><span class="va">s</span>, <span class="va">times_df</span><span class="op">$</span><span class="va">g</span><span class="op">)</span></span>
<span>    <span class="va">times_df</span><span class="op">$</span><span class="va">sld</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">nobs</span>, <span class="va">times_df</span><span class="op">$</span><span class="va">mu_sld</span>, <span class="va">object</span><span class="op">@</span><span class="va">sigma</span><span class="op">)</span></span>
<span>    <span class="va">times_df</span><span class="op">$</span><span class="va">log_haz_link</span> <span class="op">&lt;-</span> <span class="va">object</span><span class="op">@</span><span class="va">link_dsld</span> <span class="op">*</span> <span class="va">times_df</span><span class="op">$</span><span class="va">dsld</span></span>
<span>    <span class="va">times_df</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># Generate simulated data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1622</span><span class="op">)</span></span>
<span><span class="va">joint_data_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SimJointData-class.html">SimJointData</a></span><span class="op">(</span></span>
<span>    design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/SimGroup-class.html">SimGroup</a></span><span class="op">(</span><span class="fl">80</span>, <span class="st">"Arm-A"</span>, <span class="st">"Study-X"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    survival <span class="op">=</span> <span class="fu"><a href="../reference/SimSurvivalExponential.html">SimSurvivalExponential</a></span><span class="op">(</span></span>
<span>        lambda <span class="op">=</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">400</span><span class="op">)</span> <span class="op">*</span> <span class="fl">365</span>,</span>
<span>        time_max <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        time_step <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">365</span>,</span>
<span>        lambda_censor <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">9000</span>,</span>
<span>        beta_cat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span> <span class="op">=</span> <span class="fl">0</span>, <span class="st">"B"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span>, <span class="st">"C"</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>        beta_cont <span class="op">=</span> <span class="fl">0.3</span></span>
<span>    <span class="op">)</span>,</span>
<span>    longitudinal <span class="op">=</span> <span class="fu">SimWang</span><span class="op">(</span></span>
<span>        times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">200</span>, <span class="fl">300</span>, <span class="fl">400</span>, <span class="fl">600</span>,</span>
<span>                <span class="fl">800</span>, <span class="fl">1000</span>, <span class="fl">1300</span>, <span class="fl">1600</span><span class="op">)</span> <span class="op">/</span> <span class="fl">365</span>,</span>
<span>        mu_b <span class="op">=</span> <span class="fl">60</span>,</span>
<span>        mu_s <span class="op">=</span> <span class="fl">2</span>,</span>
<span>        mu_g <span class="op">=</span> <span class="fl">10</span>,</span>
<span>        omega_b <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>        omega_s <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>        omega_g <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>        sigma <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>        link_dsld <span class="op">=</span> <span class="fl">0.2</span></span>
<span>    <span class="op">)</span>,</span>
<span>    .silent <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat_lm</span> <span class="op">&lt;-</span> <span class="va">joint_data_sim</span><span class="op">@</span><span class="va">longitudinal</span></span>
<span><span class="va">dat_os</span> <span class="op">&lt;-</span> <span class="va">joint_data_sim</span><span class="op">@</span><span class="va">survival</span></span>
<span></span>
<span></span>
<span><span class="co"># Select 6 random subjects to plot</span></span>
<span><span class="va">dat_lm_plot</span> <span class="op">&lt;-</span> <span class="va">dat_lm</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">subject</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">dat_os</span><span class="op">$</span><span class="va">subject</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dat_lm_plot</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">sld</span>, group <span class="op">=</span> <span class="va">subject</span>, color <span class="op">=</span> <span class="va">subject</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time (years)"</span>, y <span class="op">=</span> <span class="st">"Tumour Size"</span>, col <span class="op">=</span> <span class="st">"Subject"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="custom-model_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="defining-the-longitudinal-model">Defining the Longitudinal Model<a class="anchor" aria-label="anchor" href="#defining-the-longitudinal-model"></a>
</h2>
<p>The longitudinal model can be implemented by extending the
<code>LongitudinalModel</code> class. This can be done as follows:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">WangModel</span> <span class="op">&lt;-</span> <span class="kw">setClass</span><span class="op">(</span></span>
<span>    <span class="st">"WangModel"</span>,</span>
<span>    contains <span class="op">=</span> <span class="st">"LongitudinalModel"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">longmodel</span> <span class="op">&lt;-</span> <span class="fu">WangModel</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/LongitudinalModel-class.html">LongitudinalModel</a></span><span class="op">(</span></span>
<span>        name <span class="op">=</span> <span class="st">"Wang"</span>,</span>
<span>        stan <span class="op">=</span> <span class="fu"><a href="../reference/StanModule-class.html">StanModule</a></span><span class="op">(</span><span class="st">"custom-model.stan"</span><span class="op">)</span>,</span>
<span>        parameters <span class="op">=</span> <span class="fu"><a href="../reference/ParameterList-class.html">ParameterList</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"mu_baseline"</span>, prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_lognormal.html">prior_lognormal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">60</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"mu_shrinkage"</span>, prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_lognormal.html">prior_lognormal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"mu_growth"</span>, prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_lognormal.html">prior_lognormal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"sigma_baseline"</span>, prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_lognormal.html">prior_lognormal</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">1</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"sigma_shrinkage"</span>, prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_lognormal.html">prior_lognormal</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">1</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"sigma_growth"</span>, prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_lognormal.html">prior_lognormal</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">1</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"sigma"</span>, prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_lognormal.html">prior_lognormal</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">1</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            <span class="co"># The following is only required if we want jmpost to generate</span></span>
<span>            <span class="co"># initial values automatically for us</span></span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span></span>
<span>                name <span class="op">=</span> <span class="st">"baseline_idv"</span>,</span>
<span>                prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_init_only.html">prior_init_only</a></span><span class="op">(</span><span class="fu"><a href="../reference/prior_lognormal.html">prior_lognormal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">60</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                size <span class="op">=</span> <span class="st">"n_subjects"</span></span>
<span>            <span class="op">)</span>,</span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span></span>
<span>                name <span class="op">=</span> <span class="st">"shrinkage_idv"</span>,</span>
<span>                prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_init_only.html">prior_init_only</a></span><span class="op">(</span><span class="fu"><a href="../reference/prior_lognormal.html">prior_lognormal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                size <span class="op">=</span> <span class="st">"n_subjects"</span></span>
<span>            <span class="op">)</span>,</span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span></span>
<span>                name <span class="op">=</span> <span class="st">"growth_idv"</span>,</span>
<span>                prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_init_only.html">prior_init_only</a></span><span class="op">(</span><span class="fu"><a href="../reference/prior_lognormal.html">prior_lognormal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                size <span class="op">=</span> <span class="st">"n_subjects"</span></span>
<span>            <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Please note that the <code>parameters</code> argument is used to
specify the priors for the model and that the <code>name</code> argument
for the <code>Parameter</code>’s objects must match the name of the
parameter used within the corresponding Stan code.</p>
<p>The <code>StanModule</code> object contains all of the stan code used
to implement the model. For this particular model the Stan code
specified in the <code>custom-model.stan</code> file is as follows:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="kw">functions</span> {</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    <span class="co">// Expected tumour size value</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    <span class="dt">vector</span> sld(<span class="dt">vector</span> tumour_time, <span class="dt">vector</span> baseline, <span class="dt">vector</span> shrinkage, <span class="dt">vector</span> growth) {</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>        <span class="dt">vector</span>[rows(tumour_time)] tumour_value;</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>        tumour_value = baseline .* exp(- shrinkage .* tumour_time)  +</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>                       growth .* tumour_time;</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>        <span class="cf">return</span> tumour_value;</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>    }</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>}</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a><span class="kw">parameters</span>{</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>    <span class="co">// Declare individual subject parameters</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>    <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt;[n_subjects] baseline_idv;</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>    <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt;[n_subjects] shrinkage_idv;</span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>    <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt;[n_subjects] growth_idv;</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>    <span class="co">// Declare population level parameters</span></span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>    <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; mu_baseline;</span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>    <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; mu_shrinkage;</span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>    <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; mu_growth;</span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>    <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma_baseline;</span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>    <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma_shrinkage;</span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a>    <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma_growth;</span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a>    <span class="co">// Declare standard deviation for the overall model error</span></span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a>    <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma;</span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a>}</span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a></span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a><span class="kw">transformed parameters</span>{</span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a>    <span class="co">// Calculated the fitted Tumour values</span></span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a>    <span class="dt">vector</span>[n_tumour_all] Ypred = sld(</span>
<span id="cb4-34"><a href="#cb4-34" tabindex="-1"></a>        tumour_time,</span>
<span id="cb4-35"><a href="#cb4-35" tabindex="-1"></a>        baseline_idv[subject_tumour_index],</span>
<span id="cb4-36"><a href="#cb4-36" tabindex="-1"></a>        shrinkage_idv[subject_tumour_index],</span>
<span id="cb4-37"><a href="#cb4-37" tabindex="-1"></a>        growth_idv[subject_tumour_index]</span>
<span id="cb4-38"><a href="#cb4-38" tabindex="-1"></a>    );</span>
<span id="cb4-39"><a href="#cb4-39" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" tabindex="-1"></a>    <span class="co">// Calculate per observation log-likelihood for {loo} integration</span></span>
<span id="cb4-41"><a href="#cb4-41" tabindex="-1"></a>    <span class="co">// These values are automatically added to the target for you</span></span>
<span id="cb4-42"><a href="#cb4-42" tabindex="-1"></a>    long_obvs_log_lik = vect_normal_log_dens(</span>
<span id="cb4-43"><a href="#cb4-43" tabindex="-1"></a>        tumour_value,</span>
<span id="cb4-44"><a href="#cb4-44" tabindex="-1"></a>        Ypred,</span>
<span id="cb4-45"><a href="#cb4-45" tabindex="-1"></a>        rep_vector(sigma, n_tumour_all) <span class="co">// broadcast sigma to the length of Ypred</span></span>
<span id="cb4-46"><a href="#cb4-46" tabindex="-1"></a>    );</span>
<span id="cb4-47"><a href="#cb4-47" tabindex="-1"></a>}</span>
<span id="cb4-48"><a href="#cb4-48" tabindex="-1"></a></span>
<span id="cb4-49"><a href="#cb4-49" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb4-50"><a href="#cb4-50" tabindex="-1"></a>    <span class="co">// Define the heirarchical relationship between the individual</span></span>
<span id="cb4-51"><a href="#cb4-51" tabindex="-1"></a>    <span class="co">// and population level parameters</span></span>
<span id="cb4-52"><a href="#cb4-52" tabindex="-1"></a>    baseline_idv ~ lognormal(log(mu_baseline), sigma_baseline);</span>
<span id="cb4-53"><a href="#cb4-53" tabindex="-1"></a>    shrinkage_idv ~ lognormal(log(mu_shrinkage), sigma_shrinkage);</span>
<span id="cb4-54"><a href="#cb4-54" tabindex="-1"></a>    growth_idv ~ lognormal(log(mu_growth), sigma_growth);</span>
<span id="cb4-55"><a href="#cb4-55" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="defining-the-link-function">Defining the Link Function<a class="anchor" aria-label="anchor" href="#defining-the-link-function"></a>
</h2>
<p>As stated in the introduction, the link function for this model is
going to be the derivative of the growth function. This can be
implemented in using the <code>jmpost</code> framework as follows:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">enableLink.WangModel</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">object</span><span class="op">@</span><span class="va">stan</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge.html">merge</a></span><span class="op">(</span></span>
<span>        <span class="va">object</span><span class="op">@</span><span class="va">stan</span>,</span>
<span>        <span class="fu"><a href="../reference/StanModule-class.html">StanModule</a></span><span class="op">(</span><span class="st">"custom-model-enable-link.stan"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">object</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="va">link</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/LinkComponent-class.html">LinkComponent</a></span><span class="op">(</span></span>
<span>    stan <span class="op">=</span> <span class="fu"><a href="../reference/StanModule-class.html">StanModule</a></span><span class="op">(</span><span class="st">"custom-model-dsld.stan"</span><span class="op">)</span>,</span>
<span>    prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_normal.html">prior_normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    key <span class="op">=</span> <span class="st">"link_dsld"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Where the Stan code for the
<code>custom-model-enable-link.stan</code> file is as follows:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>    <span class="co">// Define matrix required for link functions</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>    <span class="dt">matrix</span>[n_subjects, <span class="dv">3</span>] link_function_inputs;</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>    link_function_inputs[,<span class="dv">1</span>] = baseline_idv;</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>    link_function_inputs[,<span class="dv">2</span>] = shrinkage_idv;</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>    link_function_inputs[,<span class="dv">3</span>] = growth_idv;</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>}</span></code></pre></div>
<p>And the Stan code for the <code>custom-model-dsld.stan</code> file is
as follows:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="kw">functions</span> {</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    <span class="co">// Provide definition for the dsld link function</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    <span class="dt">matrix</span> link_dsld_contrib(<span class="dt">matrix</span> time, <span class="dt">matrix</span> link_function_inputs) {</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>        <span class="dt">int</span> nrow = rows(time);</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>        <span class="dt">int</span> ncol = cols(time);</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>        <span class="co">// broadcast input vectors to match the size of the time matrix</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>        <span class="dt">matrix</span>[nrow, ncol] baseline = rep_matrix(link_function_inputs[,<span class="dv">1</span>], ncol);</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>        <span class="dt">matrix</span>[nrow, ncol] shrinkage = rep_matrix(link_function_inputs[,<span class="dv">2</span>], ncol);</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>        <span class="dt">matrix</span>[nrow, ncol] growth = rep_matrix(link_function_inputs[,<span class="dv">3</span>], ncol);</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>        <span class="cf">return</span> growth - baseline .* shrinkage .* exp(- shrinkage .* time);</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>    }</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>}</span></code></pre></div>
<p>Note that as only one link function has been defined the
<code>enableLink</code> method is not strictly necessary and the Stan
code it contains could have been implemented directly in the
<code>stan</code> slot of the <code>LinkComponent</code> object.
However, if you have multiple link functions the <code>enableLink</code>
method is required to avoid duplicating the implementation of the
<code>link_function_inputs</code> matrix.</p>
</div>
<div class="section level2">
<h2 id="sampling-the-joint-model">Sampling the Joint model<a class="anchor" aria-label="anchor" href="#sampling-the-joint-model"></a>
</h2>
<p>With our longitudinal model defined we can now specify and sample
from the full joint model.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/JointModel-class.html">JointModel</a></span><span class="op">(</span></span>
<span>    longitudinal <span class="op">=</span> <span class="va">longmodel</span>,</span>
<span>    survival <span class="op">=</span> <span class="fu"><a href="../reference/SurvivalExponential-class.html">SurvivalExponential</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="fu"><a href="../reference/prior_gamma.html">prior_gamma</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    link <span class="op">=</span> <span class="va">link</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">joint_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/DataJoint-class.html">DataJoint</a></span><span class="op">(</span></span>
<span>    subject <span class="op">=</span> <span class="fu"><a href="../reference/DataSubject-class.html">DataSubject</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">dat_os</span>,</span>
<span>        subject <span class="op">=</span> <span class="st">"subject"</span>,</span>
<span>        arm <span class="op">=</span> <span class="st">"arm"</span>,</span>
<span>        study <span class="op">=</span> <span class="st">"study"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    survival <span class="op">=</span> <span class="fu"><a href="../reference/DataSurvival-class.html">DataSurvival</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">dat_os</span>,</span>
<span>        formula <span class="op">=</span> <span class="fu"><a href="../reference/Surv.html">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">cov_cat</span> <span class="op">+</span> <span class="va">cov_cont</span></span>
<span>    <span class="op">)</span>,</span>
<span>    longitudinal <span class="op">=</span> <span class="fu"><a href="../reference/DataLongitudinal-class.html">DataLongitudinal</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">dat_lm</span>,</span>
<span>        formula <span class="op">=</span> <span class="va">sld</span> <span class="op">~</span> <span class="va">time</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sampleStanModel.html">sampleStanModel</a></span><span class="op">(</span></span>
<span>    <span class="va">model</span>,</span>
<span>    data <span class="op">=</span> <span class="va">joint_data</span>,</span>
<span>    iter_warmup <span class="op">=</span> <span class="fl">800</span>,</span>
<span>    iter_sampling <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    chains <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    refresh <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    parallel_chains <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Running MCMC with 1 chain...</span></span>
<span><span class="co">#&gt; Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span>
<span><span class="co">#&gt; Chain 1 Exception: gamma_lpdf: Random variable is 0, but must be positive finite! (in '/tmp/Rtmp6AUkQj/model-105675d66983.stan', line 507, column 4 to column 79)</span></span>
<span><span class="co">#&gt; Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span>
<span><span class="co">#&gt; Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span>
<span><span class="co">#&gt; Chain 1</span></span>
<span><span class="co">#&gt; Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span>
<span><span class="co">#&gt; Chain 1 Exception: gamma_lpdf: Random variable is 0, but must be positive finite! (in '/tmp/Rtmp6AUkQj/model-105675d66983.stan', line 507, column 4 to column 79)</span></span>
<span><span class="co">#&gt; Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span>
<span><span class="co">#&gt; Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span>
<span><span class="co">#&gt; Chain 1</span></span>
<span><span class="co">#&gt; Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span>
<span><span class="co">#&gt; Chain 1 Exception: gamma_lpdf: Random variable is 0, but must be positive finite! (in '/tmp/Rtmp6AUkQj/model-105675d66983.stan', line 507, column 4 to column 79)</span></span>
<span><span class="co">#&gt; Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span>
<span><span class="co">#&gt; Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span>
<span><span class="co">#&gt; Chain 1</span></span>
<span><span class="co">#&gt; Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span>
<span><span class="co">#&gt; Chain 1 Exception: lognormal_lpdf: Scale parameter is 0, but must be positive finite! (in '/tmp/Rtmp6AUkQj/model-105675d66983.stan', line 484, column 4 to column 63)</span></span>
<span><span class="co">#&gt; Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span>
<span><span class="co">#&gt; Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span>
<span><span class="co">#&gt; Chain 1</span></span>
<span><span class="co">#&gt; Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span>
<span><span class="co">#&gt; Chain 1 Exception: gamma_lpdf: Random variable is 0, but must be positive finite! (in '/tmp/Rtmp6AUkQj/model-105675d66983.stan', line 507, column 4 to column 79)</span></span>
<span><span class="co">#&gt; Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span>
<span><span class="co">#&gt; Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span>
<span><span class="co">#&gt; Chain 1</span></span>
<span><span class="co">#&gt; Chain 1 finished in 9.3 seconds.</span></span>
<span></span>
<span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"mu_baseline"</span>, <span class="st">"mu_shrinkage"</span>, <span class="st">"mu_growth"</span>, <span class="st">"sigma"</span>,</span>
<span>    <span class="st">"link_dsld"</span>, <span class="st">"sm_exp_lambda"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">cmdstanr</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/cmdstan_coercion.html" class="external-link">as.CmdStanMCMC</a></span><span class="op">(</span><span class="va">model_samples</span><span class="op">)</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span><span class="va">vars</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 10</span></span></span>
<span><span class="co">#&gt;   variable       mean median     sd    mad     q5    q95  rhat ess_bulk ess_tail</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> mu_baseline  61.7   61.7   2.10   2.05   58.3   65.0   1.00     <span style="text-decoration: underline;">1</span>630.     481.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> mu_shrinkage  2.04   2.04  0.067<span style="text-decoration: underline;">5</span> 0.065<span style="text-decoration: underline;">8</span>  1.93   2.15  1.00     <span style="text-decoration: underline;">1</span>199.     721.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> mu_growth    10.2   10.2   0.288  0.279   9.75  10.7   1.00     <span style="text-decoration: underline;">1</span>873.     690.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> sigma         1.52   1.52  0.043<span style="text-decoration: underline;">5</span> 0.044<span style="text-decoration: underline;">1</span>  1.45   1.60  1.00      863.     631.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> link_dsld     0.219  0.218 0.026<span style="text-decoration: underline;">0</span> 0.025<span style="text-decoration: underline;">9</span>  0.178  0.263 1.00     <span style="text-decoration: underline;">1</span>527.     787.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> sm_exp_lamb…  1.01   0.998 0.207  0.207   0.682  1.36  0.999     850.     548.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="generating-quantities-of-interest">Generating Quantities of Interest<a class="anchor" aria-label="anchor" href="#generating-quantities-of-interest"></a>
</h2>
<p>In order to enable the generation of both population and individual
level quantities of interest we need to implement the required generated
quantity objects and functions as outlined in the “Extending jmpost”
vignette.</p>
<p>This can be done as follows:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">enableGQ.WangModel</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/StanModule-class.html">StanModule</a></span><span class="op">(</span><span class="st">"custom-model-gq.stan"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Where the Stan code for the <code>custom-model-gq.stan</code> file is
as follows:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="kw">functions</span> {</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>    <span class="co">// Define required function for enabling generated quantities</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>    <span class="dt">vector</span> lm_predict_value(<span class="dt">vector</span> time, <span class="dt">matrix</span> long_gq_parameters) {</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>        <span class="cf">return</span> sld(</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>            time,</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>            long_gq_parameters[,<span class="dv">1</span>],  <span class="co">// baseline</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>            long_gq_parameters[,<span class="dv">2</span>],  <span class="co">// shrinkage</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>            long_gq_parameters[,<span class="dv">3</span>]   <span class="co">// growth</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>        );</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>    }</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>}</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a><span class="kw">generated quantities</span> {</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>    <span class="co">// Enable individual subject predictions / quantities e.g.</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>    <span class="co">// `GridFixed()` / `GridObservation()` / `GridGrouped()` / `GridEven</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>    <span class="dt">matrix</span>[n_subjects, <span class="dv">3</span>] long_gq_parameters;</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>    long_gq_parameters[, <span class="dv">1</span>] = baseline_idv;</span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>    long_gq_parameters[, <span class="dv">2</span>] = shrinkage_idv;</span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>    long_gq_parameters[, <span class="dv">3</span>] = growth_idv;</span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>    <span class="co">// Enable Population level predictions / quantities by taking the median of the</span></span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>    <span class="co">// hierarchical distribution e.g. `GridPopulation()`</span></span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>    <span class="dt">matrix</span>[gq_n_quant, <span class="dv">3</span>] long_gq_pop_parameters;</span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>    long_gq_pop_parameters[, <span class="dv">1</span>] = rep_vector(mu_baseline, gq_n_quant);</span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a>    long_gq_pop_parameters[, <span class="dv">2</span>] = rep_vector(mu_shrinkage, gq_n_quant);</span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a>    long_gq_pop_parameters[, <span class="dv">3</span>] = rep_vector(mu_growth, gq_n_quant);</span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a>}</span></code></pre></div>
<p>With the above in place we are now able to generate quantities as
needed; this can be done at the subject level via:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">selected_subjects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat_os</span><span class="op">$</span><span class="va">subject</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">long_quantities_idv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/LongitudinalQuantities-class.html">LongitudinalQuantities</a></span><span class="op">(</span></span>
<span>    <span class="va">model_samples</span>,</span>
<span>    grid <span class="op">=</span> <span class="fu"><a href="../reference/Grid-Functions.html">GridFixed</a></span><span class="op">(</span>subjects <span class="op">=</span> <span class="va">selected_subjects</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">long_quantities_idv</span><span class="op">)</span></span></code></pre></div>
<p><img src="custom-model_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>Or at the population level via:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">long_quantities_pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/LongitudinalQuantities-class.html">LongitudinalQuantities</a></span><span class="op">(</span></span>
<span>    <span class="va">model_samples</span>,</span>
<span>    grid <span class="op">=</span> <span class="fu"><a href="../reference/Grid-Functions.html">GridPopulation</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">long_quantities_pop</span><span class="op">)</span></span></code></pre></div>
<p><img src="custom-model_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Craig Gower-Page, Francois Mercier, Daniel Sabanes Bove, Georgios Kazantzidis, Isaac Gravestock, Xiaoyan Fang, F. Hoffmann-La Roche AG.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
