<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="jmpost">
<title>Fitting a Custom Longitudinal Model • jmpost</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fitting a Custom Longitudinal Model">
<meta property="og:description" content="jmpost">
<meta property="og:image" content="https://genentech.github.io/jmpost/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">jmpost</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/custom-model.html">Fitting a Custom Longitudinal Model</a>
    <a class="dropdown-item" href="../articles/extending-jmpost.html">Extending jmpost</a>
    <a class="dropdown-item" href="../articles/model_fitting.html">Model Fitting</a>
    <a class="dropdown-item" href="../articles/statistical-specification.html">Statistical Specifications</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<!-- start dropdown for versions --> <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle"
          data-bs-toggle="dropdown" role="button"
          aria-expanded="false" aria-haspopup="true"
          id="dropdown-versions">Versions</a> <div class="dropdown-menu" aria-labelledby="dropdown-versions"> <a class="dropdown-item" data-toggle="tooltip" title="" href="https://Genentech.github.io/jmpost/main">main</a> </div></li>
<!-- end dropdown for versions -->
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-reports">Reports</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-reports">
    <a class="dropdown-item" href="../coverage-report/">Coverage report</a>
    <a class="dropdown-item" href="../unit-test-report/">Unit test report</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/genentech/jmpost/">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Fitting a Custom Longitudinal Model</h1>
            
      
      
      <div class="d-none name"><code>custom-model.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette shows a complete example for how to fit a custom
longitudinal model. Note that full details for the various different
interfaces can be found in the “Extending jmpost” vignette. This example
implements the Wang, Sung et al. 2009 mixed exponential decay and linear
growth model along with an exponential survival model. In particular the
following model will be implemented:</p>
<p><strong>Longitudinal Model</strong>: <span class="math display">\[
\begin{align}
y_{i}(t) &amp;\sim N\left(\mu_i(t),\ \sigma^2\right) \\ \\
\mu_i(t) &amp;= b_i e^{-s_it} + g_i t  \\ \\
b_i &amp;\sim \text{LogNormal}(\mu_b,\ \sigma_b) \\
s_i &amp;\sim \text{LogNormal}(\mu_s,\ \sigma_s) \\
g_i &amp;\sim \text{LogNormal}(\mu_g,\ \sigma_g) \\
\end{align}
\]</span></p>
<p>Where: * <span class="math inline">\(i\)</span> is the subject index
* <span class="math inline">\(y_{i}(t)\)</span> is the observed tumour
size measurement for subject <span class="math inline">\(i\)</span> at
time <span class="math inline">\(t\)</span> * <span class="math inline">\(\mu_i(t)\)</span> is the expected tumour size
measurement for subject <span class="math inline">\(i\)</span> at time
<span class="math inline">\(t\)</span> * <span class="math inline">\(b_i\)</span> is the subject baseline tumour size
measurement * <span class="math inline">\(s_i\)</span> is the subject
kinetics shrinkage parameter * <span class="math inline">\(g_i\)</span>
is the subject kinetics tumour growth parameter * <span class="math inline">\(\mu_{\theta}\)</span> is the population mean for
parameter <span class="math inline">\(\theta\)</span> * <span class="math inline">\(\omega_{\theta}\)</span> is the population
standard deviation for parameter <span class="math inline">\(\theta\)</span>.</p>
<p><strong>Survival Model</strong>: <span class="math display">\[
\log(h_i(t)) = \log(\lambda_0) + X_i \beta + G(t \mid b_i, s_i, g_i)
\]</span></p>
<p>Where:</p>
<ul>
<li>
<span class="math inline">\(\lambda_0\)</span> is the baseline
hazard rate. This is because for this example we are using an
exponential survival model e.g. <span class="math inline">\(h_0(t) =
\lambda_0\)</span>
</li>
<li>
<span class="math inline">\(t\)</span> is the event time</li>
<li>
<span class="math inline">\(G(.)\)</span> is a link function that
maps the subjects tumour growth parameters to a contribution to the
log-hazard function</li>
<li>
<span class="math inline">\(X_i\)</span> is the subjects covariate
design matrix</li>
<li>
<span class="math inline">\(\beta\)</span> is the corresponding
coefficients vector to scale the design matrix covariates contribution
to the log-hazard function</li>
</ul>
<p>For this example we will just consider the derivative of the growth
function as the link function, e.g. <span class="math display">\[
G(t \mid b_i, s_i, g_i) = -s_i b_i e^{-s_i t} + g_i
\]</span></p>
<p>To keep the example simple, a number of features that have been
implemented in the package’s<br>
internal models will be skipped; you may wish to consider adding these
if implementing this model in a real project. In particular the
following have been omitted from this example:</p>
<ul>
<li>Handling for censored observations (e.g. observations that are below
the limit of quantification)</li>
<li>Separate populations per study / arm</li>
<li>Non-centred parameterisation for the hierarchical parameters (this
parameterisation leads to better performance if you have small numbers
of observations per each subject).</li>
<li>Handling negative observation time (e.g. observations that are taken
before the start of the study)</li>
</ul>
<p>For reference the following libraries will be used during this
example:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">jmpost</span><span class="op">)</span></span>
<span><span class="co">#&gt; Registered S3 methods overwritten by 'ggpp':</span></span>
<span><span class="co">#&gt;   method                  from   </span></span>
<span><span class="co">#&gt;   heightDetails.titleGrob ggplot2</span></span>
<span><span class="co">#&gt;   widthDetails.titleGrob  ggplot2</span></span>
<span><span class="co">#&gt; CmdStan path set to: /root/.cmdstan/cmdstan-2.34.1</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/loo/" class="external-link">loo</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; This is loo version 2.7.0</span></span>
<span><span class="co">#&gt; - Online documentation and vignettes at mc-stan.org/loo</span></span>
<span><span class="co">#&gt; - As of v2.0.0 loo defaults to 1 core but we recommend using as many as possible. Use the 'cores' argument or set options(mc.cores = NUM_CORES) for an entire session.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="generating-simulated-data">Generating Simulated Data<a class="anchor" aria-label="anchor" href="#generating-simulated-data"></a>
</h2>
<p>In order to be confident that our model is working correctly we will
first generate some simulated data. This will allow us to compare the
true parameter values with the estimated parameter values. This can be
done using the <code>SimJointData</code> constructor function as
follows:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define our simulation parameters + object</span></span>
<span><span class="va">SimWang</span> <span class="op">&lt;-</span> <span class="kw">setClass</span><span class="op">(</span></span>
<span>    <span class="st">"SimWang"</span>,</span>
<span>    contains <span class="op">=</span> <span class="st">"SimLongitudinal"</span>,</span>
<span>    slots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        times <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        mu_b <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        mu_s <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        mu_g <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        omega_b <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        omega_s <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        omega_g <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        sigma <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        link_dsld <span class="op">=</span> <span class="st">"numeric"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Method to generate individual subjects parameters from the hierarchical distributions</span></span>
<span><span class="va">sampleSubjects.SimWang</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">subjects_df</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">nsub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">subjects_df</span><span class="op">)</span></span>
<span>    <span class="va">subjects_df</span><span class="op">$</span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="va">nsub</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">object</span><span class="op">@</span><span class="va">mu_b</span><span class="op">)</span>, <span class="va">object</span><span class="op">@</span><span class="va">omega_b</span><span class="op">)</span></span>
<span>    <span class="va">subjects_df</span><span class="op">$</span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="va">nsub</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">object</span><span class="op">@</span><span class="va">mu_s</span><span class="op">)</span>, <span class="va">object</span><span class="op">@</span><span class="va">omega_s</span><span class="op">)</span></span>
<span>    <span class="va">subjects_df</span><span class="op">$</span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="va">nsub</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">object</span><span class="op">@</span><span class="va">mu_g</span><span class="op">)</span>, <span class="va">object</span><span class="op">@</span><span class="va">omega_g</span><span class="op">)</span></span>
<span>    <span class="va">subjects_df</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Method to generate observations for each indiviudal subject</span></span>
<span><span class="va">sampleObservations.SimWang</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">times_df</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">nobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">times_df</span><span class="op">)</span></span>
<span>    <span class="va">calc_mu</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span>, <span class="va">b</span>, <span class="va">s</span>, <span class="va">g</span><span class="op">)</span> <span class="va">b</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">s</span> <span class="op">*</span> <span class="va">time</span><span class="op">)</span> <span class="op">+</span> <span class="va">g</span> <span class="op">*</span> <span class="va">time</span></span>
<span>    <span class="va">calc_dsld</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span>, <span class="va">b</span>, <span class="va">s</span>, <span class="va">g</span><span class="op">)</span> <span class="op">-</span><span class="va">s</span> <span class="op">*</span> <span class="va">b</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">s</span> <span class="op">*</span> <span class="va">time</span><span class="op">)</span> <span class="op">+</span> <span class="va">g</span></span>
<span></span>
<span>    <span class="va">times_df</span><span class="op">$</span><span class="va">mu_sld</span> <span class="op">&lt;-</span> <span class="fu">calc_mu</span><span class="op">(</span><span class="va">times_df</span><span class="op">$</span><span class="va">time</span>, <span class="va">times_df</span><span class="op">$</span><span class="va">b</span>, <span class="va">times_df</span><span class="op">$</span><span class="va">s</span>, <span class="va">times_df</span><span class="op">$</span><span class="va">g</span><span class="op">)</span></span>
<span>    <span class="va">times_df</span><span class="op">$</span><span class="va">dsld</span> <span class="op">&lt;-</span> <span class="fu">calc_dsld</span><span class="op">(</span><span class="va">times_df</span><span class="op">$</span><span class="va">time</span>, <span class="va">times_df</span><span class="op">$</span><span class="va">b</span>, <span class="va">times_df</span><span class="op">$</span><span class="va">s</span>, <span class="va">times_df</span><span class="op">$</span><span class="va">g</span><span class="op">)</span></span>
<span>    <span class="va">times_df</span><span class="op">$</span><span class="va">sld</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">nobs</span>, <span class="va">times_df</span><span class="op">$</span><span class="va">mu_sld</span>, <span class="va">object</span><span class="op">@</span><span class="va">sigma</span><span class="op">)</span></span>
<span>    <span class="va">times_df</span><span class="op">$</span><span class="va">log_haz_link</span> <span class="op">&lt;-</span> <span class="va">object</span><span class="op">@</span><span class="va">link_dsld</span> <span class="op">*</span> <span class="va">times_df</span><span class="op">$</span><span class="va">dsld</span></span>
<span>    <span class="va">times_df</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># Generate simulated data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1622</span><span class="op">)</span></span>
<span><span class="va">joint_data_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SimJointData-class.html">SimJointData</a></span><span class="op">(</span></span>
<span>    design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/SimGroup-class.html">SimGroup</a></span><span class="op">(</span><span class="fl">80</span>, <span class="st">"Arm-A"</span>, <span class="st">"Study-X"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    survival <span class="op">=</span> <span class="fu"><a href="../reference/SimSurvivalExponential.html">SimSurvivalExponential</a></span><span class="op">(</span></span>
<span>        lambda <span class="op">=</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">400</span><span class="op">)</span> <span class="op">*</span> <span class="fl">365</span>,</span>
<span>        time_max <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        time_step <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">365</span>,</span>
<span>        lambda_censor <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">9000</span>,</span>
<span>        beta_cat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span> <span class="op">=</span> <span class="fl">0</span>, <span class="st">"B"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span>, <span class="st">"C"</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>        beta_cont <span class="op">=</span> <span class="fl">0.3</span></span>
<span>    <span class="op">)</span>,</span>
<span>    longitudinal <span class="op">=</span> <span class="fu">SimWang</span><span class="op">(</span></span>
<span>        times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">200</span>, <span class="fl">300</span>, <span class="fl">400</span>, <span class="fl">600</span>,</span>
<span>                <span class="fl">800</span>, <span class="fl">1000</span>, <span class="fl">1300</span>, <span class="fl">1600</span><span class="op">)</span> <span class="op">/</span> <span class="fl">365</span>,</span>
<span>        mu_b <span class="op">=</span> <span class="fl">60</span>,</span>
<span>        mu_s <span class="op">=</span> <span class="fl">2</span>,</span>
<span>        mu_g <span class="op">=</span> <span class="fl">10</span>,</span>
<span>        omega_b <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>        omega_s <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>        omega_g <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>        sigma <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>        link_dsld <span class="op">=</span> <span class="fl">0.2</span></span>
<span>    <span class="op">)</span>,</span>
<span>    .silent <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat_lm</span> <span class="op">&lt;-</span> <span class="va">joint_data_sim</span><span class="op">@</span><span class="va">longitudinal</span></span>
<span><span class="va">dat_os</span> <span class="op">&lt;-</span> <span class="va">joint_data_sim</span><span class="op">@</span><span class="va">survival</span></span>
<span></span>
<span></span>
<span><span class="co"># Select 6 random subjects to plot</span></span>
<span><span class="va">dat_lm_plot</span> <span class="op">&lt;-</span> <span class="va">dat_lm</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">subject</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">dat_os</span><span class="op">$</span><span class="va">subject</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dat_lm_plot</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">sld</span>, group <span class="op">=</span> <span class="va">subject</span>, color <span class="op">=</span> <span class="va">subject</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time (years)"</span>, y <span class="op">=</span> <span class="st">"Tumour Size"</span>, col <span class="op">=</span> <span class="st">"Subject"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="custom-model_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="defining-the-longitudinal-model">Defining the Longitudinal Model<a class="anchor" aria-label="anchor" href="#defining-the-longitudinal-model"></a>
</h2>
<p>The longitudinal model can be implemented by extending the
<code>LongitudinalModel</code> class. This can be done as follows:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">WangModel</span> <span class="op">&lt;-</span> <span class="kw">setClass</span><span class="op">(</span></span>
<span>    <span class="st">"WangModel"</span>,</span>
<span>    contains <span class="op">=</span> <span class="st">"LongitudinalModel"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">longmodel</span> <span class="op">&lt;-</span> <span class="fu">WangModel</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/LongitudinalModel-class.html">LongitudinalModel</a></span><span class="op">(</span></span>
<span>        name <span class="op">=</span> <span class="st">"Wang"</span>,</span>
<span>        stan <span class="op">=</span> <span class="fu"><a href="../reference/StanModule-class.html">StanModule</a></span><span class="op">(</span><span class="st">"custom-model.stan"</span><span class="op">)</span>,</span>
<span>        parameters <span class="op">=</span> <span class="fu"><a href="../reference/ParameterList-class.html">ParameterList</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"mu_baseline"</span>, prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_lognormal.html">prior_lognormal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">60</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"mu_shrinkage"</span>, prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_lognormal.html">prior_lognormal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"mu_growth"</span>, prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_lognormal.html">prior_lognormal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"sigma_baseline"</span>, prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_lognormal.html">prior_lognormal</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">1</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"sigma_shrinkage"</span>, prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_lognormal.html">prior_lognormal</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">1</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"sigma_growth"</span>, prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_lognormal.html">prior_lognormal</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">1</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"sigma"</span>, prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_lognormal.html">prior_lognormal</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">1</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            <span class="co"># The following is only required if we want jmpost to generate</span></span>
<span>            <span class="co"># initial values automatically for us</span></span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span></span>
<span>                name <span class="op">=</span> <span class="st">"baseline_idv"</span>,</span>
<span>                prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_init_only.html">prior_init_only</a></span><span class="op">(</span><span class="fu"><a href="../reference/prior_lognormal.html">prior_lognormal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">60</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                size <span class="op">=</span> <span class="st">"n_subjects"</span></span>
<span>            <span class="op">)</span>,</span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span></span>
<span>                name <span class="op">=</span> <span class="st">"shrinkage_idv"</span>,</span>
<span>                prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_init_only.html">prior_init_only</a></span><span class="op">(</span><span class="fu"><a href="../reference/prior_lognormal.html">prior_lognormal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                size <span class="op">=</span> <span class="st">"n_subjects"</span></span>
<span>            <span class="op">)</span>,</span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span></span>
<span>                name <span class="op">=</span> <span class="st">"growth_idv"</span>,</span>
<span>                prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_init_only.html">prior_init_only</a></span><span class="op">(</span><span class="fu"><a href="../reference/prior_lognormal.html">prior_lognormal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                size <span class="op">=</span> <span class="st">"n_subjects"</span></span>
<span>            <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Please note that the <code>parameters</code> argument is used to
specify the priors for the model and that the <code>name</code> argument
for the <code>Parameter</code>’s objects must match the name of the
parameter used within the corresponding Stan code.</p>
<p>The <code>StanModule</code> object contains all of the stan code used
to implement the model. For this particular model the Stan code
specified in the <code>custom-model.stan</code> file is as follows:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="kw">functions</span> {</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>    <span class="co">// Expected tumour size value</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>    <span class="dt">vector</span> sld(<span class="dt">vector</span> tumour_time, <span class="dt">vector</span> baseline, <span class="dt">vector</span> shrinkage, <span class="dt">vector</span> growth) {</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>        <span class="dt">vector</span>[rows(tumour_time)] tumour_value;</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>        tumour_value = baseline .* exp(- shrinkage .* tumour_time)  +</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>                       growth .* tumour_time;</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>        <span class="cf">return</span> tumour_value;</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>    }</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>    <span class="co">// Define required function for enabling generated quantities</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>    <span class="dt">vector</span> lm_predict_value(<span class="dt">vector</span> time, <span class="dt">matrix</span> long_gq_parameters) {</span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>        <span class="cf">return</span> sld(</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>            time,</span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>            long_gq_parameters[,<span class="dv">1</span>],  <span class="co">// baseline</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>            long_gq_parameters[,<span class="dv">2</span>],  <span class="co">// shrinkage</span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>            long_gq_parameters[,<span class="dv">3</span>]   <span class="co">// growth</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>        );</span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>    }</span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>}</span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a><span class="kw">parameters</span>{</span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>    <span class="co">// Declare individual subject parameters</span></span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a>    <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt;[n_subjects] baseline_idv;</span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a>    <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt;[n_subjects] shrinkage_idv;</span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a>    <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt;[n_subjects] growth_idv;</span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a>    <span class="co">// Declare population level parameters</span></span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a>    <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; mu_baseline;</span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a>    <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; mu_shrinkage;</span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a>    <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; mu_growth;</span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a>    <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma_baseline;</span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a>    <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma_shrinkage;</span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a>    <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma_growth;</span>
<span id="cb6-35"><a href="#cb6-35" tabindex="-1"></a></span>
<span id="cb6-36"><a href="#cb6-36" tabindex="-1"></a>    <span class="co">// Declare standard deviation for the overall model error</span></span>
<span id="cb6-37"><a href="#cb6-37" tabindex="-1"></a>    <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma;</span>
<span id="cb6-38"><a href="#cb6-38" tabindex="-1"></a>}</span>
<span id="cb6-39"><a href="#cb6-39" tabindex="-1"></a></span>
<span id="cb6-40"><a href="#cb6-40" tabindex="-1"></a><span class="kw">transformed parameters</span>{</span>
<span id="cb6-41"><a href="#cb6-41" tabindex="-1"></a></span>
<span id="cb6-42"><a href="#cb6-42" tabindex="-1"></a>    <span class="co">// Calculated the fitted Tumour values</span></span>
<span id="cb6-43"><a href="#cb6-43" tabindex="-1"></a>    <span class="dt">vector</span>[n_tumour_all] Ypred = sld(</span>
<span id="cb6-44"><a href="#cb6-44" tabindex="-1"></a>        tumour_time,</span>
<span id="cb6-45"><a href="#cb6-45" tabindex="-1"></a>        baseline_idv[subject_tumour_index],</span>
<span id="cb6-46"><a href="#cb6-46" tabindex="-1"></a>        shrinkage_idv[subject_tumour_index],</span>
<span id="cb6-47"><a href="#cb6-47" tabindex="-1"></a>        growth_idv[subject_tumour_index]</span>
<span id="cb6-48"><a href="#cb6-48" tabindex="-1"></a>    );</span>
<span id="cb6-49"><a href="#cb6-49" tabindex="-1"></a></span>
<span id="cb6-50"><a href="#cb6-50" tabindex="-1"></a>    <span class="co">// Calculate per observation log-likelihood for {loo} integration</span></span>
<span id="cb6-51"><a href="#cb6-51" tabindex="-1"></a>    <span class="co">// These values are automatically added to the target for you</span></span>
<span id="cb6-52"><a href="#cb6-52" tabindex="-1"></a>    Ypred_log_lik = vect_normal_log_dens(</span>
<span id="cb6-53"><a href="#cb6-53" tabindex="-1"></a>        tumour_value,</span>
<span id="cb6-54"><a href="#cb6-54" tabindex="-1"></a>        Ypred,</span>
<span id="cb6-55"><a href="#cb6-55" tabindex="-1"></a>        rep_vector(sigma, n_tumour_all) <span class="co">// broadcast sigma to the length of Ypred</span></span>
<span id="cb6-56"><a href="#cb6-56" tabindex="-1"></a>    );</span>
<span id="cb6-57"><a href="#cb6-57" tabindex="-1"></a>}</span>
<span id="cb6-58"><a href="#cb6-58" tabindex="-1"></a></span>
<span id="cb6-59"><a href="#cb6-59" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb6-60"><a href="#cb6-60" tabindex="-1"></a>    <span class="co">// Define the heirarchical relationship between the individual</span></span>
<span id="cb6-61"><a href="#cb6-61" tabindex="-1"></a>    <span class="co">// and population level parameters</span></span>
<span id="cb6-62"><a href="#cb6-62" tabindex="-1"></a>    baseline_idv ~ lognormal(log(mu_baseline), sigma_baseline);</span>
<span id="cb6-63"><a href="#cb6-63" tabindex="-1"></a>    shrinkage_idv ~ lognormal(log(mu_shrinkage), sigma_shrinkage);</span>
<span id="cb6-64"><a href="#cb6-64" tabindex="-1"></a>    growth_idv ~ lognormal(log(mu_growth), sigma_growth);</span>
<span id="cb6-65"><a href="#cb6-65" tabindex="-1"></a>}</span>
<span id="cb6-66"><a href="#cb6-66" tabindex="-1"></a></span>
<span id="cb6-67"><a href="#cb6-67" tabindex="-1"></a></span>
<span id="cb6-68"><a href="#cb6-68" tabindex="-1"></a><span class="kw">generated quantities</span> {</span>
<span id="cb6-69"><a href="#cb6-69" tabindex="-1"></a>    <span class="co">// Enable individual subject predictions / quantities e.g.</span></span>
<span id="cb6-70"><a href="#cb6-70" tabindex="-1"></a>    <span class="co">// `GridFixed()` / `GridObservation()` / `GridGrouped()` / `GridEven</span></span>
<span id="cb6-71"><a href="#cb6-71" tabindex="-1"></a>    <span class="dt">matrix</span>[n_subjects, <span class="dv">3</span>] long_gq_parameters;</span>
<span id="cb6-72"><a href="#cb6-72" tabindex="-1"></a>    long_gq_parameters[, <span class="dv">1</span>] = baseline_idv;</span>
<span id="cb6-73"><a href="#cb6-73" tabindex="-1"></a>    long_gq_parameters[, <span class="dv">2</span>] = shrinkage_idv;</span>
<span id="cb6-74"><a href="#cb6-74" tabindex="-1"></a>    long_gq_parameters[, <span class="dv">3</span>] = growth_idv;</span>
<span id="cb6-75"><a href="#cb6-75" tabindex="-1"></a></span>
<span id="cb6-76"><a href="#cb6-76" tabindex="-1"></a>    <span class="co">// Enable Population level predictions / quantities by taking the median of the</span></span>
<span id="cb6-77"><a href="#cb6-77" tabindex="-1"></a>    <span class="co">// hierarchical distribution e.g. `GridPopulation()`</span></span>
<span id="cb6-78"><a href="#cb6-78" tabindex="-1"></a>    <span class="dt">matrix</span>[gq_n_quant, <span class="dv">3</span>] long_gq_pop_parameters;</span>
<span id="cb6-79"><a href="#cb6-79" tabindex="-1"></a>    long_gq_pop_parameters[, <span class="dv">1</span>] = rep_vector(mu_baseline, gq_n_quant);</span>
<span id="cb6-80"><a href="#cb6-80" tabindex="-1"></a>    long_gq_pop_parameters[, <span class="dv">2</span>] = rep_vector(mu_shrinkage, gq_n_quant);</span>
<span id="cb6-81"><a href="#cb6-81" tabindex="-1"></a>    long_gq_pop_parameters[, <span class="dv">3</span>] = rep_vector(mu_growth, gq_n_quant);</span>
<span id="cb6-82"><a href="#cb6-82" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="defining-the-link-function">Defining the Link Function<a class="anchor" aria-label="anchor" href="#defining-the-link-function"></a>
</h2>
<p>As stated in the introduction, the link function for this model is
going to be the derivative of the growth function. This can be
implemented in using the <code>jmpost</code> framework as follows:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">enableLink.WangModel</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">object</span><span class="op">@</span><span class="va">stan</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge.html">merge</a></span><span class="op">(</span></span>
<span>        <span class="va">object</span><span class="op">@</span><span class="va">stan</span>,</span>
<span>        <span class="fu"><a href="../reference/StanModule-class.html">StanModule</a></span><span class="op">(</span><span class="st">"custom-model-enable-link.stan"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">object</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="va">link</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/LinkComponent-class.html">LinkComponent</a></span><span class="op">(</span></span>
<span>    stan <span class="op">=</span> <span class="fu"><a href="../reference/StanModule-class.html">StanModule</a></span><span class="op">(</span><span class="st">"custom-model-dsld.stan"</span><span class="op">)</span>,</span>
<span>    prior <span class="op">=</span> <span class="fu"><a href="../reference/prior_normal.html">prior_normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    key <span class="op">=</span> <span class="st">"link_dsld"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Where the Stan code for the
<code>custom-model-enable-link.stan</code> file is as follows:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    <span class="co">// Define matrix required for link functions</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>    <span class="dt">matrix</span>[n_subjects, <span class="dv">3</span>] link_function_inputs;</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>    link_function_inputs[,<span class="dv">1</span>] = baseline_idv;</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>    link_function_inputs[,<span class="dv">2</span>] = shrinkage_idv;</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>    link_function_inputs[,<span class="dv">3</span>] = growth_idv;</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>}</span></code></pre></div>
<p>And the Stan code for the <code>custom-model-dsld.stan</code> file is
as follows:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="kw">functions</span> {</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>    <span class="co">// Provide definition for the dsld link function</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>    <span class="dt">matrix</span> link_dsld_contrib(<span class="dt">matrix</span> time, <span class="dt">matrix</span> link_function_inputs) {</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>        <span class="dt">int</span> nrow = rows(time);</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>        <span class="dt">int</span> ncol = cols(time);</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>        <span class="co">// broadcast input vectors to match the size of the time matrix</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>        <span class="dt">matrix</span>[nrow, ncol] baseline = rep_matrix(link_function_inputs[,<span class="dv">1</span>], ncol);</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>        <span class="dt">matrix</span>[nrow, ncol] shrinkage = rep_matrix(link_function_inputs[,<span class="dv">2</span>], ncol);</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>        <span class="dt">matrix</span>[nrow, ncol] growth = rep_matrix(link_function_inputs[,<span class="dv">3</span>], ncol);</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>        <span class="cf">return</span> growth - baseline .* shrinkage .* exp(- shrinkage .* time);</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>    }</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>}</span></code></pre></div>
<p>Note that as only one link function has been defined the
<code>enableLink</code> method is not strictly necessary and the Stan
code it contains could have been implemented directly in the
<code>stan</code> slot of the <code>LinkComponent</code> object.
However, if you have multiple link functions the <code>enableLink</code>
method is required to avoid duplicating the implementation of the
<code>link_function_inputs</code> matrix.</p>
</div>
<div class="section level2">
<h2 id="sampling-the-joint-model">Sampling the Joint model<a class="anchor" aria-label="anchor" href="#sampling-the-joint-model"></a>
</h2>
<p>With our longitudinal model defined we can now specify and sample
from the full joint model.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/JointModel-class.html">JointModel</a></span><span class="op">(</span></span>
<span>    longitudinal <span class="op">=</span> <span class="va">longmodel</span>,</span>
<span>    survival <span class="op">=</span> <span class="fu"><a href="../reference/SurvivalExponential-class.html">SurvivalExponential</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="fu"><a href="../reference/prior_gamma.html">prior_gamma</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    link <span class="op">=</span> <span class="va">link</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">joint_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/DataJoint-class.html">DataJoint</a></span><span class="op">(</span></span>
<span>    subject <span class="op">=</span> <span class="fu"><a href="../reference/DataSubject-class.html">DataSubject</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">dat_os</span>,</span>
<span>        subject <span class="op">=</span> <span class="st">"subject"</span>,</span>
<span>        arm <span class="op">=</span> <span class="st">"arm"</span>,</span>
<span>        study <span class="op">=</span> <span class="st">"study"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    survival <span class="op">=</span> <span class="fu"><a href="../reference/DataSurvival-class.html">DataSurvival</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">dat_os</span>,</span>
<span>        formula <span class="op">=</span> <span class="fu"><a href="../reference/Surv.html">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">cov_cat</span> <span class="op">+</span> <span class="va">cov_cont</span></span>
<span>    <span class="op">)</span>,</span>
<span>    longitudinal <span class="op">=</span> <span class="fu"><a href="../reference/DataLongitudinal-class.html">DataLongitudinal</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">dat_lm</span>,</span>
<span>        formula <span class="op">=</span> <span class="va">sld</span> <span class="op">~</span> <span class="va">time</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sampleStanModel.html">sampleStanModel</a></span><span class="op">(</span></span>
<span>    <span class="va">model</span>,</span>
<span>    data <span class="op">=</span> <span class="va">joint_data</span>,</span>
<span>    iter_warmup <span class="op">=</span> <span class="fl">800</span>,</span>
<span>    iter_sampling <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    chains <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    refresh <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    parallel_chains <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Running MCMC with 1 chain...</span></span>
<span><span class="co">#&gt; Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span>
<span><span class="co">#&gt; Chain 1 Exception: lognormal_lpdf: Scale parameter is 0, but must be positive finite! (in '/tmp/RtmpfOXeT5/model-dd212237357.stan', line 481, column 4 to column 63)</span></span>
<span><span class="co">#&gt; Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span>
<span><span class="co">#&gt; Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span>
<span><span class="co">#&gt; Chain 1</span></span>
<span><span class="co">#&gt; Chain 1 finished in 8.9 seconds.</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"mu_baseline"</span>, <span class="st">"mu_shrinkage"</span>, <span class="st">"mu_growth"</span>, <span class="st">"sigma"</span>,</span>
<span>    <span class="st">"link_dsld"</span>, <span class="st">"sm_exp_lambda"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/as.CmdStanMCMC.html">as.CmdStanMCMC</a></span><span class="op">(</span><span class="va">model_samples</span><span class="op">)</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span><span class="va">vars</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 10</span></span></span>
<span><span class="co">#&gt;   variable       mean median     sd    mad     q5    q95  rhat ess_bulk ess_tail</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> mu_baseline  61.7   61.6   2.12   2.09   58.2   65.1   0.999    <span style="text-decoration: underline;">1</span>443.     636.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> mu_shrinkage  2.04   2.04  0.069<span style="text-decoration: underline;">2</span> 0.066<span style="text-decoration: underline;">7</span>  1.93   2.15  0.999    <span style="text-decoration: underline;">1</span>356.     644.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> mu_growth    10.2   10.2   0.306  0.303   9.71  10.7   1.00     <span style="text-decoration: underline;">1</span>394.     676.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> sigma         1.52   1.52  0.039<span style="text-decoration: underline;">8</span> 0.039<span style="text-decoration: underline;">6</span>  1.46   1.59  1.01      628.     788.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> link_dsld     0.218  0.218 0.027<span style="text-decoration: underline;">2</span> 0.028<span style="text-decoration: underline;">6</span>  0.177  0.265 1.00     <span style="text-decoration: underline;">1</span>403.     670.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> sm_exp_lamb…  1.01   0.997 0.212  0.205   0.690  1.41  1.00      844.     634.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="generating-quantities-of-interest">Generating Quantities of Interest<a class="anchor" aria-label="anchor" href="#generating-quantities-of-interest"></a>
</h2>
<p>If you look at the Stan code for the above model you will notice that
several of the requirement elements for the generated quantities have
been defined thus enabling us to generate quantities both at a
population and individual subject level.</p>
<p>This can be done at the subject level via:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">selected_subjects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat_os</span><span class="op">$</span><span class="va">subject</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">long_quantities_idv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/LongitudinalQuantities-class.html">LongitudinalQuantities</a></span><span class="op">(</span></span>
<span>    <span class="va">model_samples</span>,</span>
<span>    grid <span class="op">=</span> <span class="fu"><a href="../reference/Grid-Functions.html">GridFixed</a></span><span class="op">(</span>subjects <span class="op">=</span> <span class="va">selected_subjects</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">long_quantities_idv</span><span class="op">)</span></span></code></pre></div>
<p><img src="custom-model_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>Or at the population level via:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">long_quantities_pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/LongitudinalQuantities-class.html">LongitudinalQuantities</a></span><span class="op">(</span></span>
<span>    <span class="va">model_samples</span>,</span>
<span>    grid <span class="op">=</span> <span class="fu"><a href="../reference/Grid-Functions.html">GridPopulation</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">long_quantities_pop</span><span class="op">)</span></span></code></pre></div>
<p><img src="custom-model_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Craig Gower-Page, Georgios Kazantzidis, Daniel Sabanes Bove, Xiaoyan Fang, Francois Mercier, Isaac Gravestock, F. Hoffmann-La Roche AG.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
