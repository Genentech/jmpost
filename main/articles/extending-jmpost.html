<!DOCTYPE html>
<!-- Generated by pkgdown + https://github.com/insightsengineering/r-pkgdown-multiversion -->
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Extending jmpost • jmpost</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Extending jmpost">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">jmpost</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/quickstart.html">jmpost Quickstart</a></li>
    <li><a class="dropdown-item" href="../articles/statistical-specification.html">Statistical Specifications</a></li>
    <li><a class="dropdown-item" href="../articles/custom-model.html">Fitting a Custom Longitudinal Model</a></li>
    <li><a class="dropdown-item" href="../articles/extending-jmpost.html">Extending jmpost</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-reports" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Reports</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-reports">
<li><a class="dropdown-item" href="../coverage-report/">Coverage report</a></li>
    <li><a class="dropdown-item" href="../unit-test-report/">Unit test report</a></li>
  </ul>
</li>
      <div><li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-versions">Versions</a>
    <div class="dropdown-menu" aria-labelledby="dropdown-versions">
    <a class="dropdown-item" data-toggle="tooltip" title="" href="https://Genentech.github.io/jmpost/main">main</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://Genentech.github.io/jmpost/latest-tag">latest-tag</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://Genentech.github.io/jmpost/v0.0.1">v0.0.1</a>
</div>
</li></div>
</ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/genentech/jmpost/"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Extending jmpost</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Genentech/jmpost/blob/main/vignettes/extending-jmpost.Rmd" class="external-link"><code>vignettes/extending-jmpost.Rmd</code></a></small>
      <div class="d-none name"><code>extending-jmpost.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="important">IMPORTANT<a class="anchor" aria-label="anchor" href="#important"></a>
</h2>
<p>Please note that this document is currently a work-in-progress and
does not contain complete information for this package yet.</p>
<div class="section level3">
<h3 id="custom-survival-distributions">Custom Survival Distributions<a class="anchor" aria-label="anchor" href="#custom-survival-distributions"></a>
</h3>
<p>Survival distributions in <code>jmpost</code> are specified via their
contribution to the log-hazard function. Note that at present all
distributions are implemented as proportional hazards models. This means
that for any distribution that does not have the proportional hazards
property that the distribution of any specific individual subject will
not be of the same family. That is to say the distribution family
e.g. “Log-Logistic” is just defining the baseline survival distribution
only.</p>
<p>Survival distributions are implemented as S4 classes that inherit
from <code>SurvivalModel</code>. The two main components of the
<code>SurvivalModel</code> object are the <code>stan</code> and
<code>parameters</code> slots. The <code>parameters</code> slot is a
<code>ParametersList()</code> object which is used to specify the prior
distributions of each parameter used by the survival distribution as
well as for the design matrix coefficients (please see the “Prior
Specification” section below).</p>
<p>The <code>stan</code> slot is a <code><a href="../reference/StanModule-class.html">StanModule()</a></code> object
which needs to define the following:</p>
<ol style="list-style-type: decimal">
<li><p>In the <code>parameters</code> block each of the distributions
parameters must be formally declared.</p></li>
<li><p>In the <code>transformed parameters</code> block there must
define a vector called <code>pars_os</code> which contains one element
for each parameter used by the survival distribution.</p></li>
<li><p>In the <code>functions</code> block there must define a function
called <code>log_h0</code> which returns the log-hazard contribution.
This function must have the following signature:</p></li>
</ol>
<div class="sourceCode" id="cb1"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="dt">matrix</span> log_h0(<span class="dt">matrix</span> time, <span class="dt">vector</span> pars_os)</span></code></pre></div>
<p>Where: - The return matrix must be of the same dimensionality as the
<code>time</code> argument matrix where each element is the log-hazard
contribution for the corresponding timepoint in the <code>time</code>
matrix. - The <code>time</code> matrix contains one row per unique
subject and one column per timepoint for that subject - The
<code>pars_os</code> vector is as defined from (2) above and contains
the parameters for that particular distribution.</p>
<p>For example the following is roughly equivalent to how the Weibull
distribution is implemented:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">SurvivalWeibullPH</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">lambda</span> <span class="op">=</span> <span class="fu"><a href="../reference/prior_gamma.html">prior_gamma</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    <span class="va">gamma</span> <span class="op">=</span> <span class="fu"><a href="../reference/prior_gamma.html">prior_gamma</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    <span class="va">beta</span> <span class="op">=</span> <span class="fu"><a href="../reference/prior_normal.html">prior_normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">stan</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/StanModule-class.html">StanModule</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">        functions {</span></span>
<span><span class="st">            matrix log_h0(matrix time, vector pars_os) {</span></span>
<span><span class="st">                matrix[rows(time), cols(time)] result;</span></span>
<span><span class="st">                result = log(pars_os[1]) + log(pars_os[2]) + (pars_os[2] - 1) * log(time);</span></span>
<span><span class="st">                return result;</span></span>
<span><span class="st">            }</span></span>
<span><span class="st">        }</span></span>
<span><span class="st"></span></span>
<span><span class="st">        parameters {</span></span>
<span><span class="st">            real&lt;lower=0&gt; sm_weibull_ph_lambda;</span></span>
<span><span class="st">            real&lt;lower=0&gt; sm_weibull_ph_gamma;</span></span>
<span><span class="st">        }</span></span>
<span><span class="st"></span></span>
<span><span class="st">        transformed parameters {</span></span>
<span><span class="st">            vector[2] pars_os = [sm_weibull_ph_lambda, sm_weibull_ph_gamma]';</span></span>
<span><span class="st">        }</span></span>
<span><span class="st">    "</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="../reference/SurvivalModel-class.html">SurvivalModel</a></span><span class="op">(</span></span>
<span>        stan <span class="op">=</span> <span class="va">stan</span>,</span>
<span>        parameters <span class="op">=</span> <span class="fu"><a href="../reference/ParameterList-class.html">ParameterList</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"sm_weibull_ph_lambda"</span>, prior <span class="op">=</span> <span class="va">lambda</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"sm_weibull_ph_gamma"</span>, prior <span class="op">=</span> <span class="va">gamma</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"beta_os_cov"</span>, prior <span class="op">=</span> <span class="va">beta</span>, size <span class="op">=</span> <span class="st">"p_os_cov_design"</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="custom-longitudinal-models">Custom Longitudinal Models<a class="anchor" aria-label="anchor" href="#custom-longitudinal-models"></a>
</h3>
<p>Similar to the survival model the longitudinal models are implemented
as S4 classes that inherit from the <code>LongitudinalModel</code>
class. The two main components of the <code>LongitudinalModel</code>
object are the <code>stan</code> and <code>parameters</code> slots which
specify the underlying Stan code and prior distributions for the models
parameters respectively (please see the “Prior Specification” section
below).</p>
<p>Unlike the survival distributions, the longitudinal models are a lot
more flexible and have less constraints on how they are implemented.
That is there aren’t any specific variables or functions that you need
to define.</p>
<p>That being said there are a several optional features of
<code>jmpost</code> that do require the use of specific interfaces if
you want to enable them for your model.</p>
<div class="section level4">
<h4 id="loo-integration">1) <code>loo</code> integration<a class="anchor" aria-label="anchor" href="#loo-integration"></a>
</h4>
<p>If you want to use the <code>loo</code> package to calculate the
leave-one-out cross-validation then you need to populate the
<code>long_obvs_log_lik</code> vector. This vector should contain the
log-likelihood contribution for each individual tumour observation. This
vector is automatically 0-initialised, thus all your code needs to do is
populate it.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>    long_obvs_log_lik = vect_normal_log_dens(</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>        tumour_value,</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>        expected_tumour_value,</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>        rep_vector(lm_rs_sigma, n_tumour_obs)</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>    );</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>}</span></code></pre></div>
<p>Where: - <code>tumour_value</code>, <code>n_tumour_obs</code> are
predefined data objects (see the “Longitudinal Data Objects” section
below) - <code>expected_tumour_value</code> is the expected value of the
tumour assessment for each observation - <code>lm_rs_sigma</code> is the
standard deviation of the tumour assessment -
<code>vect_normal_log_dens</code> is a vectorised version of the normal
log-likelihood function provided by <code>jmpost</code> (this is opposed
to Stan’s inbuilt <code>normal_lpdf</code> function which returns a
single value of the sum all of the log-likelihoods)</p>
</div>
<div class="section level4">
<h4 id="individual-subject-generated-quantity-integration">2) Individual Subject Generated Quantity Integration<a class="anchor" aria-label="anchor" href="#individual-subject-generated-quantity-integration"></a>
</h4>
<p>In order to calculate the individual subject generated quantities
(via <code><a href="../reference/Grid-Functions.html">GridFixed()</a></code> / <code><a href="../reference/Grid-Functions.html">GridGrouped()</a></code> / etc) you
need to define a Stan function with the signature:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="dt">vector</span> lm_predict_value(<span class="dt">vector</span> time, <span class="dt">matrix</span> long_gq_parameters)</span></code></pre></div>
<p>Where:</p>
<ul>
<li>
<code>time</code> is a vector of timepoints for which to calculate
the generated quantity</li>
<li>
<code>long_gq_parameters</code> is a matrix with one row per subject
and one column per parameter</li>
</ul>
<p>Likewise, the <code>long_gq_parameters</code> object also needs to be
defined for the model in the generated quantities block as a matrix with
1 row per subject and 1 column per parameter. This structure is to allow
for models with subject specific parameters, in particular random
effects models. If your model has the same parameters for all subjects,
for example a fixed effects model, then the value should be repeated for
each subject. Subject’s values should be in the same order as their
factor levels in the <code>DataJoint</code> object. The following is an
example from the <code>LongitudinalRandomSlope</code> model:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="kw">generated quantities</span> {</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>    <span class="dt">matrix</span>[n_subjects, <span class="dv">2</span>] long_gq_parameters;</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>    long_gq_parameters[, <span class="dv">1</span>] = lm_rs_ind_intercept;</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>    long_gq_parameters[, <span class="dv">2</span>] = lm_rs_ind_rnd_slope;</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>}</span></code></pre></div>
<p>Where:</p>
<ul>
<li>
<code>lm_rs_ind_intercept</code> and
<code>lm_rs_ind_rnd_slope</code> are the individual subject’s random
intercept and random slope parameters respectively.</li>
</ul>
<p>Note that the <code>long_gq_parameters</code> matrix should be
structured as your <code>lm_predict_value()</code> function would expect
it to be for the <code>long_gq_parameters</code> argument.</p>
<p>Please see “Custom Generated Quantities” section below for
implementation details for inserting custom generated quantity code.</p>
</div>
<div class="section level4">
<h4 id="population-generated-quantity-integration">3) Population Generated Quantity Integration<a class="anchor" aria-label="anchor" href="#population-generated-quantity-integration"></a>
</h4>
<p>A common use case is to calculate the quantities based on the
“population” level parameters which is supported in <code>jmpost</code>
via the <code><a href="../reference/Grid-Functions.html">GridPopulation()</a></code> function. What this means in
practice though is often model and parameterisation specific. For
example some models would take the median of the distribution whilst
others might take the mean or set the random effects offset to 0. As
such if you wish for your model to be compatible with the
<code><a href="../reference/Grid-Functions.html">GridPopulation()</a></code> then you need to declare and populate the
<code>long_gq_pop_parameters</code> object with the following
signature:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="dt">matrix</span>[gq_n_quant, <span class="dv">2</span>] long_gq_pop_parameters;</span></code></pre></div>
<p>Note that the number of rows is <code>gq_n_quant</code>. This number
will be set to the unique number of combinations of the arm and study
factors in the <code>DataJoint</code> object. To support populating this
object two additional variables are provided for you namely
<code>gq_long_pop_study_index</code> and
<code>gq_long_pop_arm_index</code> which are vectors that contain the
corresponding index of the study and arm variables for each row in the
<code>long_gq_pop_parameters</code> matrix. The following is an example
from the <code>LongitudinalRandomSlope</code> model:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="kw">generated quantities</span> {</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    <span class="dt">matrix</span>[gq_n_quant, <span class="dv">2</span>] long_gq_pop_parameters;</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    long_gq_pop_parameters[, <span class="dv">1</span>] = to_vector(lm_rs_intercept[gq_long_pop_study_index]);</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>    long_gq_pop_parameters[, <span class="dv">2</span>] = to_vector(lm_rs_slope_mu[gq_long_pop_arm_index]);</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>}</span></code></pre></div>
<p>Where:</p>
<ul>
<li>
<code>lm_rs_intercept</code> and <code>lm_rs_slope_mu</code> are the
model specific group level intercept and slope parameters
respectively.</li>
</ul>
<p>Note that the <code>long_gq_pop_parameters</code> matrix should be
structured as your <code>lm_predict_value()</code> function would expect
it to be for the <code>long_gq_parameters</code> argument.</p>
<p>Please see “Custom Generated Quantities” section below for
implementation details for inserting custom generated quantity code.</p>
</div>
</div>
<div class="section level3">
<h3 id="prior-specification">Prior Specification<a class="anchor" aria-label="anchor" href="#prior-specification"></a>
</h3>
<p>When writing your own custom longitudinal or survival model it is
important to understand how the prior definitions are specified. By
default <code>jmpost</code> will insert the Stan statements for any
prior distributions based on the <code>parameters</code> slot of the
model object. The importance of this is that it means you should not
define the prior distributions in the Stan code itself. Note that this
does not apply to hierarchical parameters who must have their
distributions specified in the Stan code. For example in the
<code>LongitudinalRandomSlope</code> model their is a different random
slope for each treatment arm which is specified in the Stan code as:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    lm_rs_ind_rnd_slope ~ normal(</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>        lm_rs_slope_mu[subject_arm_index],</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>        lm_rs_slope_sigma</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>    );</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>}</span></code></pre></div>
<p>There is however no prior specified in the Stan code for
<code>lm_rs_slope_mu</code> or <code>lm_rs_slope_sigma</code> as these
are handled by the <code>parameters</code> slot of the model object as
mentioned above. The main reason for using this approach is that
<code>jmpost</code> implements the priors in such a way that users can
change them without having to re-compile the Stan model.</p>
</div>
<div class="section level3">
<h3 id="custom-generated-quantities">Custom Generated Quantities<a class="anchor" aria-label="anchor" href="#custom-generated-quantities"></a>
</h3>
<p>In order to avoid unnecessary processing, code that is solely used
for generation of post sampling quantities is excluded from the Stan
program when initially sampling from the joint model. Instead this code
is only included when generating quantities via the
<code>LongitidunalQuantities</code> or <code>SurvivalQuantities</code>
constructors.</p>
<p>To facilitate this, when using <code>LongitidunalQuantities</code> or
<code>SurvivalQuantities</code>, a dedicated model method
<code><a href="../reference/enableGQ.html">enableGQ()</a></code> is called on the user provided longitudinal and
survival models. This model specific method is responsible for returning
a <code>StanModule</code> object that contains all the relevant code
required to generate the quantities for that given model. The following
is a rough implementation of this method for the Random-Slope model
which implements both feature (2) and (3) outlined in the above “Custom
Longitudinal Model” section:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">enableGQ.LongitudinalRandomSlope</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/StanModule-class.html">StanModule</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">        functions {</span></span>
<span><span class="st">            vector lm_predict_value(vector time, matrix long_gq_parameters) {</span></span>
<span><span class="st">                int nrow = rows(time);</span></span>
<span><span class="st">                return (</span></span>
<span><span class="st">                    long_gq_parameters[, 1] + long_gq_parameters[, 2] .* time</span></span>
<span><span class="st">                );</span></span>
<span><span class="st">            }</span></span>
<span><span class="st">        }</span></span>
<span><span class="st"></span></span>
<span><span class="st">        generated quantities {</span></span>
<span><span class="st">            matrix[n_subjects, 2] long_gq_parameters;</span></span>
<span><span class="st">            long_gq_parameters[, 1] = lm_rs_ind_intercept;</span></span>
<span><span class="st">            long_gq_parameters[, 2] = lm_rs_ind_rnd_slope;</span></span>
<span><span class="st"></span></span>
<span><span class="st">            matrix[gq_n_quant, 2] long_gq_pop_parameters;</span></span>
<span><span class="st">            long_gq_pop_parameters[, 1] = to_vector(lm_rs_intercept[gq_long_pop_study_index]);</span></span>
<span><span class="st">            long_gq_pop_parameters[, 2] = to_vector(lm_rs_slope_mu[gq_long_pop_arm_index]);</span></span>
<span><span class="st">        }</span></span>
<span><span class="st">    "</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Note that whilst it is possible to provide an <code><a href="../reference/enableGQ.html">enableGQ()</a></code>
method for the survival model it is not required. This is because the
underlying framework for creating survival quantities is distribution
agnostic and does not require any model specific code.</p>
</div>
<div class="section level3">
<h3 id="custom-link-functions">Custom Link Functions<a class="anchor" aria-label="anchor" href="#custom-link-functions"></a>
</h3>
<p>Users can define custom link functions in several ways based upon the
level of customisation required. In order to explain this process it is
first important to understand how the link functions are implemented
under the hood.</p>
<p>The link functions add their contribution to the likelihood function
via the log-hazard function; that is the general model is formulated
as:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>h</mi><mi>i</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>,</mo><msub><mi>ϕ</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>h</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>X</mi><mi>i</mi></msub><mi>β</mi><mo>+</mo><msub><mi>α</mi><mn>1</mn></msub><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>,</mo><msub><mi>ϕ</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>α</mi><mn>2</mn></msub><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>,</mo><msub><mi>ϕ</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mi>…</mi></mrow><annotation encoding="application/x-tex">
log(h_i(t, \phi_i)) = log(h_0(t)) + X_i \beta + \alpha_1 f(t, \phi_i) + \alpha_2 g(t, \phi_i) + \dots
</annotation></semantics></math></p>
<p>Where: -
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
is the design matrix of covariates -
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
is the vector of coefficients for the covariates -
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">f(t)</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">g(t)</annotation></semantics></math>
are the link functions -
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>α</mi><mn>1</mn></msub><annotation encoding="application/x-tex">\alpha_1</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>α</mi><mn>2</mn></msub><annotation encoding="application/x-tex">\alpha_2</annotation></semantics></math>
are the coefficients for the link functions -
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h_0(t)</annotation></semantics></math>
is the baseline hazard function -
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ϕ</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\phi_i</annotation></semantics></math>
is a vector of parameters from the longitudinal model</p>
<p>Each longitudinal model is responsible for defining their own
implementations of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ϕ</mi><annotation encoding="application/x-tex">\phi</annotation></semantics></math>
vector. The interface for doing this is by providing an
<code>enableLink</code> method that updates the <code>StanModule</code>
object of the model to define a Stan matrix with the name
<code>link_function_inputs</code> that contains 1 row per subject and 1
column per
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ϕ</mi><annotation encoding="application/x-tex">\phi</annotation></semantics></math>
parameter.</p>
<p>For reference the following is roughly the implementation for the
<code>LongitudinalGSF</code> model:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">enableLink.LongitudinalGSF</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">stan</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/StanModule-class.html">StanModule</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">transformed parameters {</span></span>
<span><span class="st">    matrix[n_subjects, 4] link_function_inputs;</span></span>
<span><span class="st">    link_function_inputs[,1] = lm_gsf_psi_bsld;</span></span>
<span><span class="st">    link_function_inputs[,2] = lm_gsf_psi_ks;</span></span>
<span><span class="st">    link_function_inputs[,3] = lm_gsf_psi_kg;</span></span>
<span><span class="st">    link_function_inputs[,4] = lm_gsf_psi_phi;</span></span>
<span><span class="st">}"</span><span class="op">)</span></span>
<span>    <span class="va">object</span><span class="op">@</span><span class="va">stan</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge.html">merge</a></span><span class="op">(</span></span>
<span>        <span class="va">object</span><span class="op">@</span><span class="va">stan</span>,</span>
<span>        <span class="va">stan</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">object</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>That is to say the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ϕ</mi><annotation encoding="application/x-tex">\phi</annotation></semantics></math>
parameters for the <code>LongitudinalGSF</code> model are the 4 primary
parameters of the longitudinal model. If you wish to augment this with
additional parameters then you can subclass the
<code>LongitudinalGSF</code> model and override the
<code>enableLink</code> method with the required additional parameters
e.g.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">GSFextended</span> <span class="op">&lt;-</span> <span class="kw">setClass</span><span class="op">(</span></span>
<span>    Class <span class="op">=</span> <span class="st">"GSFextended"</span>,</span>
<span>    contains <span class="op">=</span> <span class="st">"LongitudinalGSF"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">enableLink.GSFextended</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">stan</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/StanModule-class.html">StanModule</a></span><span class="op">(</span><span class="st">"&lt;stan-code-here&gt;"</span><span class="op">)</span></span>
<span>    <span class="va">object</span><span class="op">@</span><span class="va">stan</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge.html">merge</a></span><span class="op">(</span></span>
<span>        <span class="va">object</span><span class="op">@</span><span class="va">stan</span>,</span>
<span>        <span class="va">stan</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">object</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Next, the individual link functions are implemented as Stan functions
with the following signature:</p>
<pre><code>matrix &lt;key&gt;_contrib(
  matrix time,
  matrix link_function_inputs
)</code></pre>
<p>Where: - <code>&lt;key&gt;</code> is the name of the link parameter
as specified in the <code>LinkComponent</code> object -
<code>time</code> is a matrix of 1 row per subject and 1 column per time
point to be evaluated at for that subject.</p>
<p>The <code>LinkComponent</code> object is responsible for then
integrating these functions into the final Stan model. For reference the
following is roughly the implementation of the dSLD link component for
the <code>LongitudinalRandomSlope</code> model:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/LinkComponent-class.html">LinkComponent</a></span><span class="op">(</span></span>
<span>  key <span class="op">=</span> <span class="st">"link_dsld"</span>,</span>
<span>  stan <span class="op">=</span> <span class="fu"><a href="../reference/StanModule-class.html">StanModule</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">functions {</span></span>
<span><span class="st">    matrix link_dsld_contrib(</span></span>
<span><span class="st">        matrix time,</span></span>
<span><span class="st">        matrix link_function_inputs</span></span>
<span><span class="st">    ) {</span></span>
<span><span class="st">        int nrows = rows(time);</span></span>
<span><span class="st">        int ncols = cols(time);</span></span>
<span><span class="st">        vector[nrows] lm_rs_ind_rnd_slope = link_function_inputs[,2];</span></span>
<span><span class="st">        matrix[nrows, ncols] rnd_slope_mat = rep_matrix(lm_rs_ind_rnd_slope, ncols);</span></span>
<span><span class="st">        return rnd_slope_mat;</span></span>
<span><span class="st">    }</span></span>
<span><span class="st">}"</span><span class="op">)</span>,</span>
<span>  key <span class="op">=</span> <span class="st">"link_dsld"</span>,</span>
<span>  prior <span class="op">=</span> <span class="va">prior</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>You can then pass these <code>LinkComponent</code> objects to the
<code>link</code> argument of the <code>JointModel</code> constructor to
add them to the model e.g.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/JointModel-class.html">JointModel</a></span><span class="op">(</span></span>
<span>  longitudinal <span class="op">=</span> <span class="fu"><a href="../reference/LongitudinalRandomSlope-class.html">LongitudinalRandomSlope</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  survival <span class="op">=</span> <span class="fu"><a href="../reference/SurvivalExponential-class.html">SurvivalExponential</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  link <span class="op">=</span> <span class="fu"><a href="../reference/LinkComponent-class.html">LinkComponent</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>If you wish to add multiple link functions then you must wrap them in
a <code><a href="../reference/Link-class.html">Link()</a></code> object e.g.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/JointModel-class.html">JointModel</a></span><span class="op">(</span></span>
<span>  longitudinal <span class="op">=</span> <span class="fu"><a href="../reference/LongitudinalRandomSlope-class.html">LongitudinalRandomSlope</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  survival <span class="op">=</span> <span class="fu"><a href="../reference/SurvivalExponential-class.html">SurvivalExponential</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  link <span class="op">=</span> <span class="fu"><a href="../reference/Link-class.html">Link</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/LinkComponent-class.html">LinkComponent</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/LinkComponent-class.html">LinkComponent</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>For most users the above should be sufficient for adding your own
custom link functions for a specific analysis. The following explains
how to create your own generic link functions which can be useful if you
are wanting to share your code with other users or if you are building a
link function that is applicable to multiple longitudinal models and you
need polymorphism; this is only recommended for advanced users.</p>
<p>In order to avoid the user specify the exact model specific link
component we provide several generic functions that will return the
correct link component given their chosen link family. For example the
<code><a href="../reference/standard-link-user.html">linkDSLD()</a></code> function will return a different implementation
of the derivative of the SLD link depending on which longitudinal model
the user has provided. These are implemented as standard S3 methods
e.g.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linkDSLD.LongitudinalRandomSlope</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prior</span> <span class="op">=</span> <span class="fu"><a href="../reference/prior_normal.html">prior_normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="va">model</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/LinkComponent-class.html">LinkComponent</a></span><span class="op">(</span></span>
<span>        key <span class="op">=</span> <span class="st">"link_dsld"</span>,</span>
<span>        stan <span class="op">=</span> <span class="fu"><a href="../reference/StanModule-class.html">StanModule</a></span><span class="op">(</span><span class="st">"&lt;stan-code-here&gt;"</span><span class="op">)</span>,</span>
<span>        prior <span class="op">=</span> <span class="va">prior</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>A key design quirk to be aware of is that these methods dispatch off
of the <code>model</code> argument not the <code>prior</code> argument.
The reason for this is explained further below.</p>
<p>In order to simplify the end user API, the generic link functions
have a default <code>model</code> argument of
<code><a href="../reference/PromiseLongitudinalModel-class.html">PromiseLongitudinalModel()</a></code>. This is a special object that
is used to dispatch the
<code>link&lt;type&gt;.PromiseLongitudinalModel()</code> method which in
turn creates a <code>PromiseLinkComponent</code> object. The purpose of
these objects is to defer the creation of the <code>LinkComponent</code>
object until within the <code>JointModel</code> constructor which will
then call the <code>link&lt;Type&gt;</code> method again but with the
correct model object. As an example the following is the implementation
of the <code>linkDSLD</code> generic.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linkDSLD</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prior</span>, <span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="../reference/PromiseLongitudinalModel-class.html">PromiseLongitudinalModel</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">UseMethod</a></span><span class="op">(</span><span class="st">"linkDSLD"</span>, <span class="va">model</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">linkDSLD.PromiseLongitudinalModel</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prior</span> <span class="op">=</span> <span class="fu"><a href="../reference/prior_normal.html">prior_normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="va">model</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/PromiseLinkComponent-class.html">PromiseLinkComponent</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">linkDSLD</span>, prior <span class="op">=</span> <span class="va">prior</span>, key <span class="op">=</span> <span class="st">"link_dsld"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">linkDSLD.default</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prior</span>, <span class="va">model</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Method `linkDSLD` is not available for `%s`"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>For reference the <code>JointModel</code> constructor will then
attempt to resolve the promise by executing the provided function
against the user provided longitudinal model object e.g.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>object<span class="sc">@</span><span class="fu">fun</span>(</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>    <span class="at">prior =</span> object<span class="sc">@</span>prior,</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>    <span class="at">model =</span> <span class="sc">&lt;</span>longitudinal<span class="sc">-</span>model<span class="sc">&gt;</span>,</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="custom-simulation-functions">Custom Simulation Functions<a class="anchor" aria-label="anchor" href="#custom-simulation-functions"></a>
</h3>
<p>To assist with testing and debugging the joint models fitted via
<code>jmpost</code> the <code>SimJointData</code> constructor function
is provided to generate joint data from known parameters.</p>
<div class="section level4">
<h4 id="custom-survival-simulation-functions">Custom Survival Simulation Functions<a class="anchor" aria-label="anchor" href="#custom-survival-simulation-functions"></a>
</h4>
<p>Before describing how to implement custom survival functions it is
important to understand how the survival simulation framework works more
generally in <code>jmpost</code>. To simulate event times the simulation
function takes advantage of the following details:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>S</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><mi>U</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mi>S</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mi>e</mi><mi>x</mi><mi>p</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>−</mi><msubsup><mo>∫</mo><mn>0</mn><mi>t</mi></msubsup><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>u</mi><mo stretchy="true" form="postfix">)</mo></mrow><mspace width="0.222em"></mspace><mi>d</mi><mi>u</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
S(t) &amp;\sim U(0, 1) \\
S(t) &amp;= exp\left(-\int_0^t h(u)\ du\right)
\end{align}
</annotation></semantics></math></p>
<p>That is, it first samples a survival probability
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>
from a uniform distribution and then calculates the required event time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
to produce that survival probability. The current implementation
approximates the integral by sequentially summing up the hazard after a
given step size and declaring an event once the sampled probability
value has been exceeded. This gives rise to two key parameters that need
to be defined by the user:</p>
<ul>
<li>
<code>time_max</code>: The maximum time to simulate up to (events
occurring after this time are censored)</li>
<li>
<code>time_step</code>: How much of a gap to leave between time
points to calculate the hazard at</li>
</ul>
<p>Note that there is currently an outstanding development item to
convert this to use numerical integration to remove the need for these
parameters (see <a href="https://github.com/Genentech/jmpost/issues/329" class="external-link">issue
#329</a>).</p>
<p>Custom survival distribution simulations are implemented as classes
that inherit from <code>SimSurvival</code> providing key parameter
values and in particular provide a log-hazard function that will be used
as described above in combination with the covariate and link
contributions. The following is rough example of how the Weibull
distribution has been implemented:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">SimSurvivalWeibullPH</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">lambda</span>,</span>
<span>    <span class="va">gamma</span>,</span>
<span>    <span class="va">time_max</span> <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>    <span class="va">time_step</span> <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    <span class="va">lambda_censor</span> <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">3000</span>,</span>
<span>    <span class="va">beta_cont</span> <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>    <span class="va">beta_cat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span> <span class="op">=</span> <span class="fl">0</span>, <span class="st">"B"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">0.4</span>, <span class="st">"C"</span> <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/SimSurvival-class.html">SimSurvival</a></span><span class="op">(</span></span>
<span>        time_max <span class="op">=</span> <span class="va">time_max</span>,</span>
<span>        time_step <span class="op">=</span> <span class="va">time_step</span>,</span>
<span>        lambda_censor <span class="op">=</span> <span class="va">lambda_censor</span>,</span>
<span>        beta_cont <span class="op">=</span> <span class="va">beta_cont</span>,</span>
<span>        beta_cat <span class="op">=</span> <span class="va">beta_cat</span>,</span>
<span>        loghazard <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">gamma</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">gamma</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span></span>
<span>        <span class="op">}</span>,</span>
<span>        name <span class="op">=</span> <span class="st">"SimSurvivalWeibullPH"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>That is, the function is a essentially a constructor function for a
<code>SimSurvival</code> object. This object then has the following
slots defined:</p>
<ul>
<li>
<code>time_max</code>: The maximum time to simulate up to (as
explained mentioned above)</li>
<li>
<code>time_step</code>: How much of a gap to leave between time
points to calculate the hazard at (as explained mentioned above)</li>
<li>
<code>beta_cont</code>: The
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
coefficient for the continuous covariate (sampled from a standard normal
distribution for each subject)</li>
<li>
<code>beta_cat</code>: The
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
coefficients for the categorical covariates (evenly sampled from
<code>names(beta_cat)</code> for each subject)</li>
<li>
<code>loghazard</code>: The log-hazard function of the baseline
survival distribution</li>
<li>
<code>name</code>: The name of the simulation function; only used
for printing purposes</li>
</ul>
</div>
<div class="section level4">
<h4 id="custom-longitudinal-simulation-functions">Custom Longitudinal Simulation Functions<a class="anchor" aria-label="anchor" href="#custom-longitudinal-simulation-functions"></a>
</h4>
<p>Custom longitudinal simulation functions are slightly more involved.
Essentially the user needs to define a new class which inherits from
<code>SimLongitudinal</code> and then implement the
<code>sampleSubjects</code> and <code>sampleObservations</code> methods
for the new class. The object itself should contain all the required
parameters for the model as well as a <code>times</code> slot which is a
vector of timepoints for observations to be generated at.</p>
<p>The <code>sampleSubjects</code> method is responsible for sampling
the subject specific parameters e.g.  individual parameters for a random
effects model. The <code>sampleObservations</code> method is responsible
for calculating the tumour size at each provided time point. The
following is a rough example of how the <code>SimLongitudinalGSF</code>
class is implemented:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Declare the new class</span></span>
<span><span class="va">.SimLongitudinalGSF</span> <span class="op">&lt;-</span> <span class="kw">setClass</span><span class="op">(</span></span>
<span>    <span class="st">"SimLongitudinalGSF"</span>,</span>
<span>    contains <span class="op">=</span> <span class="st">"SimLongitudinal"</span>,</span>
<span>    slots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        sigma <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        mu_s <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        mu_g <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        mu_b <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        mu_phi <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        omega_b <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        omega_s <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        omega_g <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        omega_phi <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        link_dsld <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        link_ttg <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>        link_identity <span class="op">=</span> <span class="st">"numeric"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define constructor function with sensible default values</span></span>
<span><span class="va">SimLongitudinalGSF</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">times</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">100</span>, <span class="op">-</span><span class="fl">50</span>, <span class="fl">0</span>, <span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">150</span>, <span class="fl">250</span>, <span class="fl">350</span>, <span class="fl">450</span>, <span class="fl">550</span><span class="op">)</span> <span class="op">/</span> <span class="fl">365</span>,</span>
<span>    <span class="va">sigma</span> <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>    <span class="va">mu_s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="va">mu_g</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.35</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="va">mu_b</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">60</span><span class="op">)</span>,</span>
<span>    <span class="va">mu_phi</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">qlogis</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.6</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="va">omega_b</span> <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>    <span class="va">omega_s</span> <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>    <span class="va">omega_g</span> <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>    <span class="va">omega_phi</span> <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>    <span class="va">link_dsld</span> <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    <span class="va">link_ttg</span> <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    <span class="va">link_identity</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/SimLongitudinalGSF-class.html">.SimLongitudinalGSF</a></span><span class="op">(</span></span>
<span>        times <span class="op">=</span> <span class="va">times</span>,</span>
<span>        sigma <span class="op">=</span> <span class="va">sigma</span>,</span>
<span>        mu_s <span class="op">=</span> <span class="va">mu_s</span>,</span>
<span>        mu_g <span class="op">=</span> <span class="va">mu_g</span>,</span>
<span>        mu_b <span class="op">=</span> <span class="va">mu_b</span>,</span>
<span>        mu_phi <span class="op">=</span> <span class="va">mu_phi</span>,</span>
<span>        omega_b <span class="op">=</span> <span class="va">omega_b</span>,</span>
<span>        omega_s <span class="op">=</span> <span class="va">omega_s</span>,</span>
<span>        omega_g <span class="op">=</span> <span class="va">omega_g</span>,</span>
<span>        omega_phi <span class="op">=</span> <span class="va">omega_phi</span>,</span>
<span>        link_dsld <span class="op">=</span> <span class="va">link_dsld</span>,</span>
<span>        link_ttg <span class="op">=</span> <span class="va">link_ttg</span>,</span>
<span>        link_identity <span class="op">=</span> <span class="va">link_identity</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">sampleSubjects.SimLongitudinalGSF</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">subjects_df</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">res</span> <span class="op">&lt;-</span> <span class="va">subjects_df</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>study_idx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">study</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>arm_idx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">arm</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>psi_b <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">object</span><span class="op">@</span><span class="va">mu_b</span><span class="op">[</span><span class="va">.data</span><span class="op">$</span><span class="va">study_idx</span><span class="op">]</span>, <span class="va">object</span><span class="op">@</span><span class="va">omega_b</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>psi_s <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">object</span><span class="op">@</span><span class="va">mu_s</span><span class="op">[</span><span class="va">.data</span><span class="op">$</span><span class="va">arm_idx</span><span class="op">]</span>, <span class="va">object</span><span class="op">@</span><span class="va">omega_s</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>psi_g <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">object</span><span class="op">@</span><span class="va">mu_g</span><span class="op">[</span><span class="va">.data</span><span class="op">$</span><span class="va">arm_idx</span><span class="op">]</span>, <span class="va">object</span><span class="op">@</span><span class="va">omega_g</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>psi_phi_logit <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span></span>
<span>            <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            <span class="va">object</span><span class="op">@</span><span class="va">mu_phi</span><span class="op">[</span><span class="va">.data</span><span class="op">$</span><span class="va">arm_idx</span><span class="op">]</span>,</span>
<span>            <span class="va">object</span><span class="op">@</span><span class="va">omega_phi</span></span>
<span>        <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>psi_phi <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">psi_phi_logit</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">res</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"subject"</span>, <span class="st">"arm"</span>, <span class="st">"study"</span>, <span class="st">"psi_b"</span>, <span class="st">"psi_s"</span>, <span class="st">"psi_g"</span>, <span class="st">"psi_phi"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">sampleObservations.SimLongitudinalGSF</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">times_df</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">times_df</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>mu_sld <span class="op">=</span> <span class="fu"><a href="../reference/gsf_sld.html">gsf_sld</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">time</span>, <span class="va">.data</span><span class="op">$</span><span class="va">psi_b</span>, <span class="va">.data</span><span class="op">$</span><span class="va">psi_s</span>, <span class="va">.data</span><span class="op">$</span><span class="va">psi_g</span>, <span class="va">.data</span><span class="op">$</span><span class="va">psi_phi</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>dsld <span class="op">=</span> <span class="fu"><a href="../reference/gsf_sld.html">gsf_dsld</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">time</span>, <span class="va">.data</span><span class="op">$</span><span class="va">psi_b</span>, <span class="va">.data</span><span class="op">$</span><span class="va">psi_s</span>, <span class="va">.data</span><span class="op">$</span><span class="va">psi_g</span>, <span class="va">.data</span><span class="op">$</span><span class="va">psi_phi</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ttg <span class="op">=</span> <span class="fu"><a href="../reference/gsf_sld.html">gsf_ttg</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">time</span>, <span class="va">.data</span><span class="op">$</span><span class="va">psi_b</span>, <span class="va">.data</span><span class="op">$</span><span class="va">psi_s</span>, <span class="va">.data</span><span class="op">$</span><span class="va">psi_g</span>, <span class="va">.data</span><span class="op">$</span><span class="va">psi_phi</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sld <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">.data</span><span class="op">$</span><span class="va">mu_sld</span>, <span class="va">.data</span><span class="op">$</span><span class="va">mu_sld</span> <span class="op">*</span> <span class="va">object</span><span class="op">@</span><span class="va">sigma</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>            log_haz_link <span class="op">=</span></span>
<span>                <span class="op">(</span><span class="va">object</span><span class="op">@</span><span class="va">link_dsld</span> <span class="op">*</span> <span class="va">.data</span><span class="op">$</span><span class="va">dsld</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="op">(</span><span class="va">object</span><span class="op">@</span><span class="va">link_ttg</span> <span class="op">*</span> <span class="va">.data</span><span class="op">$</span><span class="va">ttg</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="op">(</span><span class="va">object</span><span class="op">@</span><span class="va">link_identity</span> <span class="op">*</span> <span class="va">.data</span><span class="op">$</span><span class="va">mu_sld</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The <code>subjects_df</code> argument to the
<code>sampleSubjects</code> method is a <code>data.frame</code> with the
following columns:</p>
<ul>
<li>
<code>subject</code>: The subject identifier</li>
<li>
<code>arm</code>: The treatment arm that the subject belongs to</li>
<li>
<code>study</code>: The study that the subject belongs to</li>
</ul>
<p>Of note is that this dataset contains one row per subject. The return
value must be a <code>data.frame</code> with the same number of rows as
the input dataset as well as the <code>subject</code>, <code>arm</code>
and <code>study</code> columns. The remaining columns are the subject
specific parameters and can have any arbitrary name.</p>
<p>The <code>times_df</code> argument to the
<code>sampleObservations</code> method is the same
<code>data.frame</code> that was generated in the
<code>sampleSubjects</code> method but duplicated once per required
timepoint with an additional <code>time</code> column that contains said
timepoint. The return value must be a <code>data.frame</code> with the
same number of rows as the input dataset as well as the original columns
<code>subject</code>, <code>arm</code>, <code>study</code> and
<code>time</code>. In addition to the original columns the function must
also define the following new columns:</p>
<ul>
<li>
<code>sld</code>: The tumour size at the given timepoint</li>
<li>
<code>log_haz_link</code>: The contribution to the hazard function
at that timepoint (set this to 0 if not defining a link function)</li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="formatting-stan-files">Formatting Stan Files<a class="anchor" aria-label="anchor" href="#formatting-stan-files"></a>
</h3>
<p>Under the hood this library works by merging multiple Stan programs
together into a single program. It does this by parsing the program to
extract out each block independently. Unfortunately, the formal Stan
parser (<code>stanc</code>) provided by the Stan team only works with
complete programs whereas most of the programs within
<code>jmpost</code> are incomplete fragments. This package has therefore
implemented its own simple parser; as a result, in order to not have to
traverse the full abstract syntax tree (AST), a few addition constraints
are made on how Stan programs can be formatted.</p>
<p>These additional constraints are:</p>
<ul>
<li>The opening to each block must start on a newline and can’t have any
non-whitespace character proceeding it.</li>
<li>The opening to each block cannot have any non-whitespace characters
after the opening <code>{</code> character.</li>
<li>The closing <code>}</code> character after each block cannot have
any non-whitespace characters after it</li>
</ul>
<p>Valid:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>  <span class="dt">int</span> n; <span class="dt">array</span>[n] <span class="dt">real</span> x;</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>}       </span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a><span class="kw">parameters</span>{      </span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>  <span class="dt">real</span> mu; </span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>  <span class="dt">real</span> sigma;}</span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>    <span class="kw">model</span> {    </span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a>x ~ normal(mu, sigma);</span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a>    }    </span></code></pre></div>
<p>Invalid:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="co">// non-whitespace after opening `{`</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="kw">data</span> { <span class="dt">int</span> n; <span class="dt">array</span>[n] <span class="dt">real</span> x; } </span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>parameter { <span class="dt">real</span> mu;      <span class="co">// non-whitespace after opening `{`</span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>  <span class="dt">real</span> sigma;</span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>} <span class="kw">model</span> {                 <span class="co">// non-whitespace before block name</span></span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a>  x ~ normal(mu, sigma);</span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a>} <span class="co">// some comment         // non-whitespace after closing `}`</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="stan-data-objects">Stan Data Objects<a class="anchor" aria-label="anchor" href="#stan-data-objects"></a>
</h3>
<p>When writing your own Stan code to extend <code>jmpost</code> it is
important to note that many different data objects have already been
defined in the <code>data</code> block of the base Stan template. This
section outlines the different data objects that are made available to
user. Note that some objects are only made available if the
corresponding model is used; for example death times are only available
if the user specifies a <code>SurvivalModel</code> object to
<code><a href="../reference/JointModel-class.html">JointModel()</a></code>.</p>
<div class="section level4">
<h4 id="global-data-objects">Global Data Objects<a class="anchor" aria-label="anchor" href="#global-data-objects"></a>
</h4>
<p><strong>Number of unique subjects</strong></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; n_subjects;</span></code></pre></div>
<p><strong>Number of unique studies</strong></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; n_studies;</span></code></pre></div>
<p><strong>Number of unique treatment arms</strong></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; n_arms;</span></code></pre></div>
<p><strong>Study index for each subject</strong></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="dt">array</span>[n_subjects] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>,<span class="kw">upper</span>=n_studies&gt; subject_study_index;</span></code></pre></div>
<ul>
<li>Note that this is sorted based upon the subject’s factor level
within the R <code>data.frame</code>. For example lets say subject
<code>"A"</code> has a factor level of 15 and that their corresponding
study value has a factor level of 2 then
<code>subject_study_index[15]</code> will be 2.</li>
</ul>
<p><strong>Treatment arm index for each subject</strong></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>  <span class="dt">array</span>[n_subjects] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>,<span class="kw">upper</span>=n_arms&gt; subject_arm_index;</span></code></pre></div>
<ul>
<li>A mirror of <code>subject_study_index</code> but for the treatment
arm.</li>
</ul>
</div>
<div class="section level4">
<h4 id="survival-data-objects">Survival Data Objects<a class="anchor" aria-label="anchor" href="#survival-data-objects"></a>
</h4>
<p><strong>Number of events</strong></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; n_subject_event;</span></code></pre></div>
<p><strong>Event/Censor Times</strong></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="dt">vector</span>[n_subjects] event_times;</span></code></pre></div>
<ul>
<li>Ordered by subject factor level</li>
</ul>
<p><strong>Event Index</strong></p>
<div class="sourceCode" id="cb30"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="dt">array</span>[n_subject_event] <span class="dt">int</span> subject_event_index;</span></code></pre></div>
<ul>
<li>Is the index into <code>event_times</code> to identify which times
are an event. The rest are censored.</li>
</ul>
<p><strong>Number of covariates for the survival model</strong></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; p_os_cov_design;</span></code></pre></div>
<ul>
<li>Note that this does not include an intercept term, which would
conflict with the baseline distribution parameters.</li>
</ul>
<p><strong>Covariate design matrix for the survival model</strong></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="dt">matrix</span>[n_subjects, p_os_cov_design] os_cov_design;</span></code></pre></div>
<ul>
<li>Note that this does not include an intercept term, which would
conflict with the baseline distribution parameters.</li>
</ul>
<p><strong>Time &gt;0 flag</strong></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="dt">array</span>[rows(event_times)] <span class="dt">int</span> time_positive_flag;</span></code></pre></div>
<p><strong>Number of times &gt;0</strong></p>
<div class="sourceCode" id="cb34"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a><span class="dt">int</span> n_times_positive;</span></code></pre></div>
<p><strong>Positive time index</strong></p>
<div class="sourceCode" id="cb35"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a><span class="dt">array</span>[n_times_positive] <span class="dt">int</span> time_positive_index</span></code></pre></div>
<p><strong>Gaussian Quadrature Integration Parameters</strong></p>
<div class="sourceCode" id="cb36"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; n_nodes;</span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a><span class="dt">vector</span>[n_nodes] nodes;</span>
<span id="cb36-3"><a href="#cb36-3" tabindex="-1"></a><span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>, <span class="kw">upper</span>=<span class="dv">1</span>&gt;[n_nodes] weights;</span></code></pre></div>
<ul>
<li>These are the nodes and weights for the Gaussian quadrature
integration.</li>
</ul>
</div>
<div class="section level4">
<h4 id="longitudinal-data-objects">Longitudinal Data Objects<a class="anchor" aria-label="anchor" href="#longitudinal-data-objects"></a>
</h4>
<p><strong>Total number of tumour assessments</strong></p>
<div class="sourceCode" id="cb37"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; n_tumour_all;</span></code></pre></div>
<p><strong>Number of tumour assessments above LLoQ (Lower Limit of
Quantification)</strong></p>
<div class="sourceCode" id="cb38"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; n_tumour_obs;</span></code></pre></div>
<p><strong>Number of tumour assessments below LLoQ (Lower Limit of
Quantification)</strong></p>
<div class="sourceCode" id="cb39"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; n_tumour_cens;</span></code></pre></div>
<p><strong>Tumour assessments values</strong></p>
<div class="sourceCode" id="cb40"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a><span class="dt">vector</span>[n_tumour_all] tumour_value;</span></code></pre></div>
<p><strong>Tumour assessments time points</strong></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a><span class="dt">vector</span>[n_tumour_all] tumour_time;</span></code></pre></div>
<p><strong>LLoQ threshold</strong></p>
<div class="sourceCode" id="cb42"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a><span class="dt">real</span> tumour_value_lloq;</span></code></pre></div>
<p><strong>Individual tumour assessment index</strong></p>
<div class="sourceCode" id="cb43"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a><span class="dt">array</span>[n_tumour_all] <span class="dt">int</span> subject_tumour_index;</span></code></pre></div>
<ul>
<li>That is if tumour assessment 1 belongs to the subject with factor
level 3 then <code>subject_tumour_index[1]</code> will be 3.</li>
</ul>
<p><strong>Tumour assessment index for observations above LLoQ (Lower
Limit of Quantification)</strong></p>
<div class="sourceCode" id="cb44"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a><span class="dt">array</span>[n_tumour_obs] <span class="dt">int</span> subject_tumour_index_obs;</span></code></pre></div>
<ul>
<li>For example if only tumour assessments 3 and 5 were above the LLoQ
then <code>subject_tumour_index_obs</code> will be
<code>[3, 5]</code>.</li>
</ul>
<p><strong>Tumour assessment index for observations below LLoQ (Lower
Limit of Quantification)</strong></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a><span class="dt">array</span>[n_tumour_cens] <span class="dt">int</span> subject_tumour_index_cens;</span></code></pre></div>
<ul>
<li>For example if only tumour assessments 1 and 2 were below the LLoQ
then <code>subject_tumour_index_obs</code> will be
<code>[1, 2]</code>.</li>
</ul>
<p><strong>Sparse matrix components for subject indexes of the tumour
assessments</strong></p>
<div class="sourceCode" id="cb46"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb46-1"><a href="#cb46-1" tabindex="-1"></a><span class="dt">array</span> [<span class="dv">3</span>] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; n_mat_inds_all_y;</span>
<span id="cb46-2"><a href="#cb46-2" tabindex="-1"></a><span class="dt">vector</span>[n_mat_inds_all_y[<span class="dv">1</span>]] w_mat_inds_all_y;</span>
<span id="cb46-3"><a href="#cb46-3" tabindex="-1"></a><span class="dt">array</span>[n_mat_inds_all_y[<span class="dv">2</span>]] <span class="dt">int</span> v_mat_inds_all_y;</span>
<span id="cb46-4"><a href="#cb46-4" tabindex="-1"></a><span class="dt">array</span>[n_mat_inds_all_y[<span class="dv">3</span>]] <span class="dt">int</span> u_mat_inds_all_y;</span></code></pre></div>
<ul>
<li>This is the sparse matrix representation of the binary matrix that
has one row per subject and one column per tumour assessment. That is,
for row 3 of this matrix all columns that have an entry of 1 indicate
that the corresponding entry in <code>tumour_value</code> belongs to the
subject with factor level 3. This matrix is primarily used to calculate
the sum of log-likelihood for all tumour assessments per subject in an
efficient way.</li>
<li>See <a href="https://mc-stan.org/docs/functions-reference/sparse_matrix_operations.html#CSR" class="external-link">the
Stan CSR documentation</a> for more information on the sparse matrix
representation.</li>
</ul>
<p><strong>Sparse matrix components for subject indexes of the tumour
assessments above the LLoQ</strong></p>
<div class="sourceCode" id="cb47"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a><span class="dt">array</span> [<span class="dv">3</span>] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; n_mat_inds_obs_y;</span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a><span class="dt">vector</span>[n_mat_inds_obs_y[<span class="dv">1</span>]] w_mat_inds_obs_y;</span>
<span id="cb47-3"><a href="#cb47-3" tabindex="-1"></a><span class="dt">array</span>[n_mat_inds_obs_y[<span class="dv">2</span>]] <span class="dt">int</span> v_mat_inds_obs_y;</span>
<span id="cb47-4"><a href="#cb47-4" tabindex="-1"></a><span class="dt">array</span>[n_mat_inds_obs_y[<span class="dv">3</span>]] <span class="dt">int</span> u_mat_inds_obs_y;</span></code></pre></div>
<ul>
<li>Same as above but only for the tumour assessments above the
LLoQ.</li>
</ul>
<p><strong>Sparse matrix components for subject indexes of the tumour
assessments below the LLoQ</strong></p>
<div class="sourceCode" id="cb48"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a><span class="dt">array</span> [<span class="dv">3</span>] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; n_mat_inds_cens_y;</span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a><span class="dt">vector</span>[n_mat_inds_cens_y[<span class="dv">1</span>]] w_mat_inds_cens_y;</span>
<span id="cb48-3"><a href="#cb48-3" tabindex="-1"></a><span class="dt">array</span>[n_mat_inds_cens_y[<span class="dv">2</span>]] <span class="dt">int</span> v_mat_inds_cens_y;</span>
<span id="cb48-4"><a href="#cb48-4" tabindex="-1"></a><span class="dt">array</span>[n_mat_inds_cens_y[<span class="dv">3</span>]] <span class="dt">int</span> u_mat_inds_cens_y;</span></code></pre></div>
<ul>
<li>Same as above but only for the tumour assessments below the
LLoQ.</li>
</ul>
</div>
<div class="section level4">
<h4 id="global-quantity-data-objects">Global Quantity Data Objects<a class="anchor" aria-label="anchor" href="#global-quantity-data-objects"></a>
</h4>
<p><strong>Number of quantities to be generated</strong></p>
<div class="sourceCode" id="cb49"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a><span class="dt">int</span> &lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; gq_n_quant;</span></code></pre></div>
<p><strong>Assessment time for that the corresponding quantity should be
generated at</strong></p>
<div class="sourceCode" id="cb50"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a><span class="dt">vector</span>[gq_n_quant] gq_times;</span></code></pre></div>
<p><strong>subject index for each quantity</strong></p>
<div class="sourceCode" id="cb51"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb51-1"><a href="#cb51-1" tabindex="-1"></a><span class="dt">array</span>[gq_n_quant] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>, <span class="kw">upper</span>=n_subjects&gt; gq_subject_index;</span></code></pre></div>
<ul>
<li>
<code><a href="../reference/Grid-Functions.html">GridFixed()</a></code> / <code><a href="../reference/Grid-Functions.html">GridGrouped()</a></code> /
<code><a href="../reference/Grid-Functions.html">GridObserved()</a></code> / <code><a href="../reference/Grid-Functions.html">GridManual()</a></code> only</li>
</ul>
</div>
<div class="section level4">
<h4 id="survival-quantity-data-objects">Survival Quantity Data Objects<a class="anchor" aria-label="anchor" href="#survival-quantity-data-objects"></a>
</h4>
<p><strong>Number of link parameters</strong></p>
<div class="sourceCode" id="cb52"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; gq_n_par;</span></code></pre></div>
<ul>
<li>
<code><a href="../reference/Grid-Functions.html">GridPrediction()</a></code> only</li>
</ul>
<p><strong>Matrix of link function inputs</strong></p>
<div class="sourceCode" id="cb53"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb53-1"><a href="#cb53-1" tabindex="-1"></a><span class="dt">matrix</span>[gq_n_quant, gq_n_par] gq_link_function_inputs;</span></code></pre></div>
<ul>
<li>
<code><a href="../reference/Grid-Functions.html">GridPrediction()</a></code> only</li>
</ul>
<p><strong>Design matrix for the survival quantity model</strong></p>
<div class="sourceCode" id="cb54"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb54-1"><a href="#cb54-1" tabindex="-1"></a><span class="dt">matrix</span>[gq_n_quant, p_os_cov_design] gq_os_cov_design;</span></code></pre></div>
<ul>
<li>
<code><a href="../reference/Grid-Functions.html">GridPrediction()</a></code> only</li>
</ul>
</div>
<div class="section level4">
<h4 id="longitudinal-quantity-data-objects">Longitudinal Quantity Data Objects<a class="anchor" aria-label="anchor" href="#longitudinal-quantity-data-objects"></a>
</h4>
<p><strong>Arm index for each quantity</strong></p>
<div class="sourceCode" id="cb55"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb55-1"><a href="#cb55-1" tabindex="-1"></a><span class="dt">array</span> [gq_n_quant] <span class="dt">int</span> &lt;<span class="kw">lower</span>=<span class="dv">1</span>, <span class="kw">upper</span>=n_arms&gt; gq_long_pop_arm_index;</span></code></pre></div>
<ul>
<li>
<code><a href="../reference/Grid-Functions.html">GridPopulation()</a></code> only</li>
</ul>
<p><strong>Study index for each quantity</strong></p>
<div class="sourceCode" id="cb56"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb56-1"><a href="#cb56-1" tabindex="-1"></a><span class="dt">array</span> [gq_n_quant] <span class="dt">int</span> &lt;<span class="kw">lower</span>=<span class="dv">1</span>, <span class="kw">upper</span>=n_studies&gt; gq_long_pop_study_index;</span></code></pre></div>
<ul>
<li>
<code><a href="../reference/Grid-Functions.html">GridPopulation()</a></code> only</li>
</ul>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Craig Gower-Page, Francois Mercier, Daniel Sabanes Bove, Georgios Kazantzidis, Isaac Gravestock, Xiaoyan Fang, F. Hoffmann-La Roche AG.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
