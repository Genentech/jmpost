<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="jmpost">
<title>Extending jmpost • jmpost</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Extending jmpost">
<meta property="og:description" content="jmpost">
<meta property="og:image" content="https://genentech.github.io/jmpost/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">jmpost</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/extending-jmpost.html">Extending jmpost</a>
    <a class="dropdown-item" href="../articles/model_fitting.html">Model Fitting</a>
    <a class="dropdown-item" href="../articles/statistical-specification.html">Statistical Specifications</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<!-- start dropdown for versions --> <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle"
          data-bs-toggle="dropdown" role="button"
          aria-expanded="false" aria-haspopup="true"
          id="dropdown-versions">Versions</a> <div class="dropdown-menu" aria-labelledby="dropdown-versions"> <a class="dropdown-item" data-toggle="tooltip" title="" href="https://Genentech.github.io/jmpost/main">main</a> </div></li>
<!-- end dropdown for versions -->
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-reports">Reports</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-reports">
    <a class="dropdown-item" href="../coverage-report/">Coverage report</a>
    <a class="dropdown-item" href="../unit-test-report/">Unit test report</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/genentech/jmpost/">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Extending jmpost</h1>
            
      
      
      <div class="d-none name"><code>extending-jmpost.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="important">IMPORTANT<a class="anchor" aria-label="anchor" href="#important"></a>
</h2>
<p>Please note that this document is currently a work-in-progress and
does not contain complete information for this package yet.</p>
<div class="section level3">
<h3 id="custom-link-functions">Custom Link Functions<a class="anchor" aria-label="anchor" href="#custom-link-functions"></a>
</h3>
<p>Users can define custom link functions in several ways based upon the
level of customisation required. In order to explain this process it is
first important to understand how the link functions are implemented
under the hood.</p>
<p>The link functions add their contribution to the likelihood function
via the log-hazard function; that is the general model is formulated
as:</p>
<p><span class="math display">\[
log(h_i(t, \phi_i)) = log(h_0(t)) + X_i \beta + \alpha_1 f(t, \phi_i) +
\alpha_2 g(t, \phi_i) + \dots
\]</span></p>
<p>Where: - <span class="math inline">\(X\)</span> is the design matrix
of covariates - <span class="math inline">\(\beta\)</span> is the vector
of coefficients for the covariates - <span class="math inline">\(f(t)\)</span> and <span class="math inline">\(g(t)\)</span> are the link functions - <span class="math inline">\(\alpha_1\)</span> and <span class="math inline">\(\alpha_2\)</span> are the coefficients for the
link functions - <span class="math inline">\(h_0(t)\)</span> is the
baseline hazard function - <span class="math inline">\(\phi_i\)</span>
is a vector of parameters from the longitudinal model</p>
<p>Each longitudinal model is responsible for defining their own
implementations of the <span class="math inline">\(\phi\)</span> vector.
The interface for doing this is by providing an <code>enableLink</code>
method that updates the <code>StanModule</code> object of the model to
define a Stan matrix with the name <code>link_function_inputs</code>
that contains 1 row per patient and 1 column per <span class="math inline">\(\phi\)</span> parameter.</p>
<p>For reference the following is roughly the implementation for the
<code>LongitudinalGSF</code> model:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">enableLink.LongitudinalGSF</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">stan</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/StanModule-class.html">StanModule</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">transformed parameters {</span></span>
<span><span class="st">    matrix[n_subjects, 4] link_function_inputs;</span></span>
<span><span class="st">    link_function_inputs[,1] = lm_gsf_psi_bsld;</span></span>
<span><span class="st">    link_function_inputs[,2] = lm_gsf_psi_ks;</span></span>
<span><span class="st">    link_function_inputs[,3] = lm_gsf_psi_kg;</span></span>
<span><span class="st">    link_function_inputs[,4] = lm_gsf_psi_phi;</span></span>
<span><span class="st">}"</span><span class="op">)</span></span>
<span>    <span class="va">object</span><span class="op">@</span><span class="va">stan</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge.html">merge</a></span><span class="op">(</span></span>
<span>        <span class="va">object</span><span class="op">@</span><span class="va">stan</span>,</span>
<span>        <span class="va">stan</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">object</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>That is to say the <span class="math inline">\(\phi\)</span>
parameters for the <code>LongitudinalGSF</code> model are the 4 primary
parameters of the longitudinal model. If you wish to augment this with
additional parameters then you can subclass the
<code>LongitudinalGSF</code> model and override the
<code>enableLink</code> method to the required additional parameters
e.g.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">GSFextended</span> <span class="op">&lt;-</span> <span class="kw">setClass</span><span class="op">(</span></span>
<span>    Class <span class="op">=</span> <span class="st">"GSFextended"</span>,</span>
<span>    contains <span class="op">=</span> <span class="st">"LongitudinalGSF"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">enableLink.GSFextended</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">stan</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/StanModule-class.html">StanModule</a></span><span class="op">(</span><span class="st">"&lt;your stan code here&gt;"</span><span class="op">)</span></span>
<span>    <span class="va">object</span><span class="op">@</span><span class="va">stan</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge.html">merge</a></span><span class="op">(</span></span>
<span>        <span class="va">object</span><span class="op">@</span><span class="va">stan</span>,</span>
<span>        <span class="va">stan</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">object</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Next, the individual link functions are implemented as Stan functions
with the following signature:</p>
<pre><code>matrix &lt;key&gt;_contrib(
  matrix time,
  matrix link_function_inputs
)</code></pre>
<p>Where: - <code>&lt;key&gt;</code> is the name of the link parameter
as specified in the <code>LinkComponent</code> object -
<code>time</code> is a matrix of 1 row per patient and 1 column per time
point to be evaluated at for that patient.</p>
<p>The <code>LinkComponent</code> object is responsible for then
integrating these functions into the final Stan model. For reference the
following is roughly the implementation of the dSLD link for the
<code>LongitudinalRandomSlope</code> model:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/LinkComponent-class.html">LinkComponent</a></span><span class="op">(</span></span>
<span>  key <span class="op">=</span> <span class="st">"link_dsld"</span>,</span>
<span>  stan <span class="op">=</span> <span class="fu"><a href="../reference/StanModule-class.html">StanModule</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">functions {</span></span>
<span><span class="st">    matrix link_dsld_contrib(</span></span>
<span><span class="st">        matrix time,</span></span>
<span><span class="st">        matrix link_function_inputs</span></span>
<span><span class="st">    ) {</span></span>
<span><span class="st">        int nrows = rows(time);</span></span>
<span><span class="st">        int ncols = cols(time);</span></span>
<span><span class="st">        vector[nrows] lm_rs_ind_rnd_slope = link_function_inputs[,2];</span></span>
<span><span class="st">        matrix[nrows, ncols] rnd_slope_mat = rep_matrix(lm_rs_ind_rnd_slope, ncols);</span></span>
<span><span class="st">        return rnd_slope_mat;</span></span>
<span><span class="st">    }</span></span>
<span><span class="st">}"</span><span class="op">)</span>,</span>
<span>  parameters <span class="op">=</span> <span class="fu"><a href="../reference/ParameterList-class.html">ParameterList</a></span><span class="op">(</span><span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"link_dsld"</span>, prior <span class="op">=</span> <span class="va">prior</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>You can then pass these <code>LinkComponent</code> objects to the
<code>link</code> argument of the <code>JointModel</code> constructor to
add them to the model. If you wish to add multiple link functions then
you must wrap them in a <code><a href="../reference/Link-class.html">Link()</a></code> object e.g.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/Link-class.html">Link</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/LinkComponent-class.html">LinkComponent</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/LinkComponent-class.html">LinkComponent</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note that there are a few families of link functions that are common
across all models for example identity, dSLD, TTG. Users can access
these by simply using the inbuilt <code><a href="../reference/standard-links.html">link_identity()</a></code>,
<code><a href="../reference/standard-links.html">link_dsld()</a></code> and <code><a href="../reference/standard-links.html">link_ttg()</a></code> functions
respectively.</p>
<p>These functions are responsible for loading the correct
<code>LinkComponent</code> to implement that link for a particular
model. That is if the user wants to specify both the TTG link and the
dSLD for a model then they can do so via:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/JointModel-class.html">JointModel</a></span><span class="op">(</span></span>
<span>  <span class="va">...</span>,</span>
<span>  link <span class="op">=</span> <span class="fu"><a href="../reference/Link-class.html">Link</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/standard-links.html">link_dsld</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/standard-links.html">link_ttg</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> </span></code></pre></div>
<p>Under the hood these link-family functions work by defining a
<code>LinkComponent</code> object that specifies a method that will
return a <code>StanModule</code> object instead of specifying the
<code>StanModule</code> object directly. This method will then be called
by the <code>JointModel</code> constructor with the
<code>LongitudinalModel</code> object as its first argument. This way
each longitudinal model is able to specify their own implementation for
the given link family. The following is a rough outline for how this
works for the <code><a href="../reference/standard-links.html">link_dsld()</a></code> function and the
<code>LongitudinalGSF</code> model:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">link_dsld</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/LinkComponent-class.html">LinkComponent</a></span><span class="op">(</span></span>
<span>    key <span class="op">=</span> <span class="st">"link_dsld"</span>,</span>
<span>    stan <span class="op">=</span> <span class="va">linkDSLD</span>,</span>
<span>    parameters <span class="op">=</span> <span class="fu"><a href="../reference/ParameterList-class.html">ParameterList</a></span><span class="op">(</span><span class="fu"><a href="../reference/Parameter-class.html">Parameter</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"link_dsld"</span>, prior <span class="op">=</span> <span class="va">prior</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">linkDSLD.LongitudinalGSF</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/StanModule-class.html">StanModule</a></span><span class="op">(</span><span class="st">"&lt;stan code for GSF dSLD link&gt;"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This is to say that if you wish to overwrite a model implementation
for an existing link family or provide an implementation for a new model
then you can do so by defining/overwriting the relevant methods. For
clarity the underlying methods are <code>linkDSLD</code>,
<code>linkIdentity</code> and <code>linkTTG</code> respectively.</p>
</div>
<div class="section level3">
<h3 id="formatting-stan-files">Formatting Stan Files<a class="anchor" aria-label="anchor" href="#formatting-stan-files"></a>
</h3>
<p>Under the hood this library works by merging multiple Stan programs
together into a single program. It does this by parsing the program to
extract out each block independently. Unfortunately, the formal Stan
parser (<code>stanc</code>) provided by the Stan team only works with
complete programs whereas most of the programs within
<code>jmpost</code> are incomplete fragments. This package has therefore
implemented its own simple parser; as a result, in order to not have to
traverse the full abstract syntax tree (AST), a few addition constraints
are made on how Stan programs can be formatted.</p>
<p>These additional constraints are:</p>
<ul>
<li>The opening to each block must start on a newline and can’t have any
non-whitespace character proceeding it.</li>
<li>The opening to each block cannot have any non-whitespace characters
after the opening <code>{</code> character.</li>
<li>The closing <code>}</code> character after each block cannot have
any non-whitespace characters after it</li>
</ul>
<p>Valid:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  <span class="dt">int</span> n; <span class="dt">array</span>[n] <span class="dt">real</span> x;</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>}       </span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="kw">parameters</span>{      </span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>  <span class="dt">real</span> mu; </span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>  <span class="dt">real</span> sigma;}</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>    <span class="kw">model</span> {    </span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>x ~ normal(mu, sigma);</span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>    }    </span></code></pre></div>
<p>Invalid:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co">// non-whitespace after opening `{`</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="kw">data</span> { <span class="dt">int</span> n; <span class="dt">array</span>[n] <span class="dt">real</span> x; } </span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>parameter { <span class="dt">real</span> mu;      <span class="co">// non-whitespace after opening `{`</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>  <span class="dt">real</span> sigma;</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>} <span class="kw">model</span> {                 <span class="co">// non-whitespace before block name</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>  x ~ normal(mu, sigma);</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>} <span class="co">// some comment         // non-whitespace after closing `}`</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="stan-data-objects">Stan Data Objects<a class="anchor" aria-label="anchor" href="#stan-data-objects"></a>
</h3>
<p>When writing your own Stan code to extend <code>jmpost</code> it is
important to note that many different data objects have already been
defined in the <code>data</code> block of the base Stan template. This
section outlines the different data objects that are made available to
user. Note that some objects are only made available if the
corresponding model is used; for example death times are only available
if the user specifies a <code>SurvivalModel</code> object to
<code><a href="../reference/JointModel-class.html">JointModel()</a></code>.</p>
<div class="section level4">
<h4 id="global-data-objects">Global Data Objects<a class="anchor" aria-label="anchor" href="#global-data-objects"></a>
</h4>
<p><strong>Number of unique subjects</strong></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; n_subjects;</span></code></pre></div>
<p><strong>Number of unique studies</strong></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; n_studies;</span></code></pre></div>
<p><strong>Number of unique treatment arms</strong></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; n_arms;</span></code></pre></div>
<p><strong>Study index for each subject</strong></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="dt">array</span>[n_subjects] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>,<span class="kw">upper</span>=n_studies&gt; subject_study_index;</span></code></pre></div>
<ul>
<li>Note that this is sorted based upon the subject’s factor level
within the R <code>data.frame</code>. For example lets say subject
<code>"A"</code> has a factor level of 15 and that their corresponding
study value has a factor level of 2 then
<code>subject_study_index[15]</code> will be 2.</li>
</ul>
<p><strong>Treatment arm index for each subject</strong></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>  <span class="dt">array</span>[n_subjects] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>,<span class="kw">upper</span>=n_arms&gt; subject_arm_index;</span></code></pre></div>
<ul>
<li>A mirror of <code>subject_study_index</code> but for the treatment
arm.</li>
</ul>
</div>
<div class="section level4">
<h4 id="survival-data-objects">Survival Data Objects<a class="anchor" aria-label="anchor" href="#survival-data-objects"></a>
</h4>
<p><strong>Number of events</strong></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; n_subject_event;</span></code></pre></div>
<p><strong>Event/Censor Times</strong></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="dt">vector</span>[n_subjects] event_times;</span></code></pre></div>
<ul>
<li>Ordered by patient factor level</li>
</ul>
<p><strong>Event Index</strong></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="dt">array</span>[n_subject_event] <span class="dt">int</span> subject_event_index;</span></code></pre></div>
<ul>
<li>Is the index into <code>event_times</code> to identify which times
are an event. The rest are censored.</li>
</ul>
<p><strong>Number of covariates for the survival model</strong></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; p_os_cov_design;</span></code></pre></div>
<ul>
<li>Note that this does not include an intercept term, which would
conflict with the baseline distribution parameters.</li>
</ul>
<p><strong>Covariate design matrix for the survival model</strong></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="dt">matrix</span>[n_subjects, p_os_cov_design] os_cov_design;</span></code></pre></div>
<ul>
<li>Note that this does not include an intercept term, which would
conflict with the baseline distribution parameters.</li>
</ul>
<p><strong>Time &gt;0 flag</strong></p>
<div class="sourceCode" id="cb20"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="dt">array</span>[rows(event_times)] <span class="dt">int</span> time_positive_flag;</span></code></pre></div>
<p><strong>Number of times &gt;0</strong></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="dt">int</span> n_times_positive;</span></code></pre></div>
<p><strong>Positive time index</strong></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="dt">array</span>[n_times_positive] <span class="dt">int</span> time_positive_index</span></code></pre></div>
<p><strong>Gaussian Quadrature Integration Parameters</strong></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; n_nodes;</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="dt">vector</span>[n_nodes] nodes;</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a><span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>, <span class="kw">upper</span>=<span class="dv">1</span>&gt;[n_nodes] weights;</span></code></pre></div>
<ul>
<li>These are the nodes and weights for the Gaussian quadrature
integration.</li>
</ul>
</div>
<div class="section level4">
<h4 id="longitudinal-data-objects">Longitudinal Data Objects<a class="anchor" aria-label="anchor" href="#longitudinal-data-objects"></a>
</h4>
<p><strong>Total number of tumour assessments</strong></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; n_tumour_all;</span></code></pre></div>
<p><strong>Number of tumour assessments above LLoQ (Lower Limit of
Quantification)</strong></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; n_tumour_obs;</span></code></pre></div>
<p><strong>Number of tumour assessments below LLoQ (Lower Limit of
Quantification)</strong></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; n_tumour_cens;</span></code></pre></div>
<p><strong>Tumour assessments values</strong></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="dt">vector</span>[n_tumour_all] tumour_value;</span></code></pre></div>
<p><strong>Tumour assessments time points</strong></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="dt">vector</span>[n_tumour_all] tumour_time;</span></code></pre></div>
<p><strong>LLoQ threshold</strong></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="dt">real</span> tumour_value_lloq;</span></code></pre></div>
<p><strong>Individual tumour assessment index</strong></p>
<div class="sourceCode" id="cb30"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="dt">array</span>[n_tumour_all] <span class="dt">int</span> subject_tumour_index;</span></code></pre></div>
<ul>
<li>That is if tumour assessment 1 belongs to the patient with factor
level 3 then <code>subject_tumour_index[1]</code> will be 3.</li>
</ul>
<p><strong>Tumour assessment index for observations above LLoQ (Lower
Limit of Quantification)</strong></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="dt">array</span>[n_tumour_obs] <span class="dt">int</span> subject_tumour_index_obs;</span></code></pre></div>
<ul>
<li>For example if only tumour assessments 3 and 5 were above the LLoQ
then <code>subject_tumour_index_obs</code> will be
<code>[3, 5]</code>.</li>
</ul>
<p><strong>Tumour assessment index for observations below LLoQ (Lower
Limit of Quantification)</strong></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="dt">array</span>[n_tumour_cens] <span class="dt">int</span> subject_tumour_index_cens;</span></code></pre></div>
<ul>
<li>For example if only tumour assessments 1 and 2 were below the LLoQ
then <code>subject_tumour_index_obs</code> will be
<code>[1, 2]</code>.</li>
</ul>
<p><strong>Sparse matrix components for patient indexes of the tumour
assessments</strong></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="dt">array</span> [<span class="dv">3</span>] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; n_mat_inds_all_y;</span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a><span class="dt">vector</span>[n_mat_inds_all_y[<span class="dv">1</span>]] w_mat_inds_all_y;</span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a><span class="dt">array</span>[n_mat_inds_all_y[<span class="dv">2</span>]] <span class="dt">int</span> v_mat_inds_all_y;</span>
<span id="cb33-4"><a href="#cb33-4" tabindex="-1"></a><span class="dt">array</span>[n_mat_inds_all_y[<span class="dv">3</span>]] <span class="dt">int</span> u_mat_inds_all_y;</span></code></pre></div>
<ul>
<li>This is the sparse matrix representation of the binary matrix that
has one row per patient and one column per tumour assessment. That is,
for row 3 of this matrix all columns that have an entry of 1 indicate
that the corresponding entry in <code>tumour_value</code> belongs to the
patient with factor level 3. This matrix is primarily used to calculate
the sum of log-likelihood for all tumour assessments per patient in an
efficient way.</li>
<li>See <a href="https://mc-stan.org/docs/functions-reference/sparse_matrix_operations.html#CSR" class="external-link">the
Stan CSR documentation</a> for more information on the sparse matrix
representation.</li>
</ul>
<p><strong>Sparse matrix components for patient indexes of the tumour
assessments above the LLoQ</strong></p>
<div class="sourceCode" id="cb34"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a><span class="dt">array</span> [<span class="dv">3</span>] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; n_mat_inds_obs_y;</span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a><span class="dt">vector</span>[n_mat_inds_obs_y[<span class="dv">1</span>]] w_mat_inds_obs_y;</span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a><span class="dt">array</span>[n_mat_inds_obs_y[<span class="dv">2</span>]] <span class="dt">int</span> v_mat_inds_obs_y;</span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a><span class="dt">array</span>[n_mat_inds_obs_y[<span class="dv">3</span>]] <span class="dt">int</span> u_mat_inds_obs_y;</span></code></pre></div>
<ul>
<li>Same as above but only for the tumour assessments above the
LLoQ.</li>
</ul>
<p><strong>Sparse matrix components for patient indexes of the tumour
assessments below the LLoQ</strong></p>
<div class="sourceCode" id="cb35"><pre class="sourceCode stan"><code class="sourceCode stan"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a><span class="dt">array</span> [<span class="dv">3</span>] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; n_mat_inds_cens_y;</span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a><span class="dt">vector</span>[n_mat_inds_cens_y[<span class="dv">1</span>]] w_mat_inds_cens_y;</span>
<span id="cb35-3"><a href="#cb35-3" tabindex="-1"></a><span class="dt">array</span>[n_mat_inds_cens_y[<span class="dv">2</span>]] <span class="dt">int</span> v_mat_inds_cens_y;</span>
<span id="cb35-4"><a href="#cb35-4" tabindex="-1"></a><span class="dt">array</span>[n_mat_inds_cens_y[<span class="dv">3</span>]] <span class="dt">int</span> u_mat_inds_cens_y;</span></code></pre></div>
<ul>
<li>Same as above but only for the tumour assessments below the
LLoQ.</li>
</ul>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Craig Gower-Page, Georgios Kazantzidis, Daniel Sabanes Bove, Xiaoyan Fang, Francois Mercier, Isaac Gravestock, F. Hoffmann-La Roche AG.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
